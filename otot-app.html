<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××•×ª×•×ª â€” ××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    --glass-bg: rgba(255,255,255,0.12);
    --glass-border: rgba(255,255,255,0.25);
    --glass-shadow: 0 8px 32px rgba(0,0,0,0.18);
    --blur: blur(18px);
    --radius: 22px;
    --accent: #7c5cfc;
    --accent2: #e96bd1;
    --accent3: #5ccffc;
    --text: #fff;
    --text-muted: rgba(255,255,255,0.65);
    --danger: #ff5c7c;
    --success: #5cfca0;
    --warn: #ffd56b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Heebo', sans-serif;
    min-height: 100vh;
    background: linear-gradient(135deg, #0f0c29 0%, #1a1040 35%, #24243e 65%, #0f2027 100%);
    color: var(--text);
    overflow-x: hidden;
    position: relative;
  }

  /* Pride flag background - subtle, blended */
  .pride-bg {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-15deg);
    width: 160%;
    height: 55%;
    z-index: 0;
    pointer-events: none;
    opacity: 0.04;
    border-radius: 40px;
    background: linear-gradient(
      180deg,
      #FF0018 0%,    #FF0018 16.66%,
      #FFA52C 16.66%, #FFA52C 33.33%,
      #FFFF41 33.33%, #FFFF41 50%,
      #008018 50%,    #008018 66.66%,
      #0000F9 66.66%, #0000F9 83.33%,
      #86007D 83.33%, #86007D 100%
    );
  }

  /* Ambient orbs */
  .orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    pointer-events: none;
    z-index: 0;
    opacity: 0.35;
  }
  .orb1 { width: 500px; height: 500px; background: radial-gradient(circle, #7c5cfc, transparent); top: -150px; right: -100px; }
  .orb2 { width: 400px; height: 400px; background: radial-gradient(circle, #e96bd1, transparent); bottom: -100px; left: -80px; }
  .orb3 { width: 300px; height: 300px; background: radial-gradient(circle, #5ccffc, transparent); top: 40%; left: 40%; }

  /* Noise overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");
    opacity: 0.025;
    pointer-events: none;
    z-index: 1;
  }

  /* Glass card */
  .glass {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: var(--blur);
    -webkit-backdrop-filter: var(--blur);
    border-radius: var(--radius);
    box-shadow: var(--glass-shadow);
  }

  .glass-dark {
    background: rgba(0,0,0,0.22);
    border: 1px solid rgba(255,255,255,0.12);
    backdrop-filter: var(--blur);
    -webkit-backdrop-filter: var(--blur);
    border-radius: var(--radius);
    box-shadow: var(--glass-shadow);
  }

  /* Layout */
  #app { position: relative; z-index: 2; min-height: 100vh; }

  /* Auth screen */
  #auth-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
  }

  .auth-card {
    width: 100%;
    max-width: 420px;
    padding: 40px 36px;
  }

  .logo-area {
    text-align: center;
    margin-bottom: 32px;
  }

  .logo-icon {
    width: 72px;
    height: 72px;
    margin: 0 auto 16px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    box-shadow: 0 8px 32px rgba(124,92,252,0.4);
  }

  .logo-title {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff, rgba(255,255,255,0.7));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .logo-sub { font-size: 14px; color: var(--text-muted); margin-top: 6px; }

  /* Tabs */
  .auth-tabs {
    display: flex;
    gap: 4px;
    background: rgba(0,0,0,0.2);
    border-radius: 14px;
    padding: 4px;
    margin-bottom: 28px;
  }

  .auth-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.25s ease;
    border: none;
    background: transparent;
  }

  .auth-tab.active {
    background: rgba(255,255,255,0.18);
    color: white;
    font-weight: 600;
  }

  /* Form inputs */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px; }

  .form-input {
    width: 100%;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 14px;
    padding: 13px 16px;
    color: white;
    font-family: 'Heebo', sans-serif;
    font-size: 15px;
    transition: all 0.2s ease;
    outline: none;
  }

  .form-input:focus {
    border-color: var(--accent);
    background: rgba(124,92,252,0.12);
    box-shadow: 0 0 0 3px rgba(124,92,252,0.2);
  }

  .form-input::placeholder { color: rgba(255,255,255,0.3); }

  select.form-input option { background: #1a1040; color: white; }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 24px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
    box-shadow: 0 6px 24px rgba(124,92,252,0.4);
    width: 100%;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(124,92,252,0.5);
  }

  .btn-primary:active { transform: translateY(0); }

  .btn-glass {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.22);
    color: white;
    backdrop-filter: blur(8px);
  }

  .btn-glass:hover { background: rgba(255,255,255,0.2); }

  .btn-danger {
    background: rgba(255,92,124,0.2);
    border: 1px solid rgba(255,92,124,0.4);
    color: var(--danger);
  }

  .btn-danger:hover { background: rgba(255,92,124,0.35); }

  .btn-sm { padding: 8px 14px; font-size: 13px; border-radius: 10px; }

  /* Main app layout */
  #main-app { display: none; min-height: 100vh; }

  /* Header */
  .app-header {
    position: sticky;
    top: 0;
    z-index: 100;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(15,12,41,0.7);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .header-logo { font-size: 20px; font-weight: 800; letter-spacing: -0.3px; }
  .header-logo span { background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

  .header-user {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
  }

  .user-name { font-size: 14px; font-weight: 500; }

  /* Nav */
  .app-nav {
    display: flex;
    gap: 4px;
    padding: 16px 24px;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .app-nav::-webkit-scrollbar { display: none; }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 12px;
    border: 1px solid transparent;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    background: transparent;
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  .nav-btn.active {
    background: rgba(124,92,252,0.2);
    border-color: rgba(124,92,252,0.4);
    color: white;
  }

  .nav-btn:hover:not(.active) { background: rgba(255,255,255,0.08); color: white; }

  /* Content */
  .app-content {
    padding: 0 24px 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* Dashboard */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    padding: 24px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: -20px;
    left: -20px;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    opacity: 0.15;
  }

  .stat-card.purple::before { background: var(--accent); }
  .stat-card.pink::before { background: var(--accent2); }
  .stat-card.blue::before { background: var(--accent3); }
  .stat-card.green::before { background: var(--success); }

  .stat-icon { font-size: 28px; margin-bottom: 12px; }
  .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .stat-value { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
  .stat-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

  /* Shift list */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-title { font-size: 18px; font-weight: 700; }

  .shift-list { display: flex; flex-direction: column; gap: 10px; }

  .shift-item {
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s;
  }

  .shift-item:hover { background: rgba(255,255,255,0.14); }

  .shift-date-badge {
    text-align: center;
    min-width: 52px;
  }

  .shift-day { font-size: 22px; font-weight: 800; }
  .shift-month { font-size: 11px; color: var(--text-muted); font-weight: 500; }

  .shift-info { flex: 1; }
  .shift-type-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .badge-night { background: rgba(92,207,252,0.2); color: var(--accent3); }
  .badge-day { background: rgba(255,213,107,0.2); color: var(--warn); }
  .badge-shabbat { background: rgba(124,92,252,0.2); color: #b39ddb; }
  .badge-holiday { background: rgba(233,107,209,0.2); color: var(--accent2); }
  .badge-training { background: rgba(92,252,160,0.2); color: var(--success); }
  .badge-meeting { background: rgba(255,92,124,0.2); color: var(--danger); }
  .badge-full { background: rgba(255,165,44,0.2); color: #FFA52C; }

  .shift-times { font-size: 13px; color: var(--text-muted); }
  .shift-pay { font-size: 18px; font-weight: 700; }
  .shift-hours { font-size: 12px; color: var(--text-muted); }

  .shift-actions { display: flex; gap: 6px; }

  /* Add shift modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.open { display: flex; }

  .modal-card {
    width: 100%;
    max-width: 520px;
    padding: 32px;
    background: rgba(15,12,41,0.92);
    border: 1px solid rgba(255,255,255,0.2);
    backdrop-filter: blur(24px);
    border-radius: var(--radius);
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }

  .modal-title { font-size: 20px; font-weight: 700; }

  .close-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .close-btn:hover { background: rgba(255,92,124,0.3); }

  /* Salary preview */
  .salary-preview {
    background: rgba(124,92,252,0.1);
    border: 1px solid rgba(124,92,252,0.3);
    border-radius: 14px;
    padding: 16px;
    margin-top: 16px;
  }

  .salary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
  }

  .salary-row:not(:last-child) { border-bottom: 1px solid rgba(255,255,255,0.08); }
  .salary-total { font-size: 18px; font-weight: 700; color: var(--success); }

  /* Settings / Profile */
  .settings-section { margin-bottom: 24px; }
  .settings-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; }

  /* Admin panel */
  .admin-gate {
    padding: 40px;
    text-align: center;
  }

  .admin-icon { font-size: 48px; margin-bottom: 16px; }
  .admin-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
  .admin-sub { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }

  .user-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    border-radius: 14px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .user-info { flex: 1; }
  .user-email { font-size: 14px; font-weight: 500; }
  .user-meta { font-size: 12px; color: var(--text-muted); }

  /* Export */
  .export-area {
    padding: 40px;
    text-align: center;
  }

  /* Notifications */
  .notif {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 500;
    padding: 14px 24px;
    border-radius: 14px;
    font-size: 14px;
    font-weight: 500;
    backdrop-filter: blur(16px);
    animation: slideDown 0.3s ease;
    display: none;
  }

  .notif.show { display: block; }
  .notif.success { background: rgba(92,252,160,0.2); border: 1px solid rgba(92,252,160,0.4); color: var(--success); }
  .notif.error { background: rgba(255,92,124,0.2); border: 1px solid rgba(255,92,124,0.4); color: var(--danger); }

  @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

  /* Monthly summary chart */
  .chart-container {
    padding: 24px;
    margin-bottom: 24px;
  }

  .mini-bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 6px;
    height: 80px;
  }

  .mini-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }

  .mini-bar {
    width: 100%;
    border-radius: 6px 6px 0 0;
    background: linear-gradient(180deg, var(--accent), var(--accent2));
    transition: height 0.5s ease;
    min-height: 4px;
  }

  .mini-bar-label { font-size: 10px; color: var(--text-muted); }

  /* Loading spinner */
  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Responsive */
  @media (max-width: 640px) {
    .app-header { padding: 12px 16px; }
    .app-content { padding: 0 16px 40px; }
    .app-nav { padding: 12px 16px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .modal-card { padding: 24px 20px; }
    .shift-pay { font-size: 15px; }
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-icon { font-size: 48px; margin-bottom: 16px; }
  .empty-text { font-size: 16px; font-weight: 500; }
  .empty-sub { font-size: 13px; margin-top: 6px; }

  /* Pride stripe accent in header */
  .pride-stripe {
    height: 3px;
    background: linear-gradient(90deg, #FF0018, #FFA52C, #FFFF41, #008018, #0000F9, #86007D);
    border-radius: 0 0 2px 2px;
    opacity: 0.6;
  }
</style>
</head>
<body>

<!-- Ambient effects -->
<div class="pride-bg"></div>
<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="orb orb3"></div>

<!-- Notification -->
<div class="notif" id="notif"></div>

<div id="app">

  <!-- AUTH SCREEN -->
  <div id="auth-screen">
    <div class="glass auth-card">
      <div class="logo-area">
        <div class="logo-icon">ğŸŒŸ</div>
        <div class="logo-title">××•×ª×•×ª</div>
        <div class="logo-sub">××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª ×•×©×›×¨</div>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">×”×ª×—×‘×¨×•×ª</button>
        <button class="auth-tab" onclick="switchAuthTab('register')">×”×¨×©××”</button>
      </div>

      <!-- Login Form -->
      <div id="login-form">
        <div class="form-group">
          <label class="form-label">××™××™×™×œ</label>
          <input type="email" class="form-input" id="login-email" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">×¡×™×¡××”</label>
          <input type="password" class="form-input" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn btn-primary" onclick="doLogin()" id="login-btn">
          <span>×›× ×™×¡×” ×œ××¢×¨×›×ª</span>
        </button>
      </div>

      <!-- Register Form -->
      <div id="register-form" style="display:none">
        <div class="form-group">
          <label class="form-label">×©× ××œ×</label>
          <input type="text" class="form-input" id="reg-name" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
        </div>
        <div class="form-group">
          <label class="form-label">××™××™×™×œ</label>
          <input type="email" class="form-input" id="reg-email" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">×¡×™×¡××”</label>
          <input type="password" class="form-input" id="reg-password" placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×">
        </div>
        <div class="form-group">
          <label class="form-label">×•×ª×§ (×—×•×“×©×™× ××ª×—×™×œ×ª ×¢×‘×•×“×”)</label>
          <input type="number" class="form-input" id="reg-seniority" placeholder="0" min="0">
        </div>
        <button class="btn btn-primary" onclick="doRegister()" id="reg-btn">
          <span>×™×¦×™×¨×ª ×—×©×‘×•×Ÿ</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="main-app">
    <div class="pride-stripe"></div>

    <!-- Header -->
    <header class="app-header">
      <div class="header-logo">××•×ª<span>×•×ª</span></div>
      <nav class="app-nav" style="padding: 0; flex: 1; justify-content: center;">
        <button class="nav-btn active" onclick="showPage('dashboard')" id="nav-dashboard">ğŸ“Š ×“××©×‘×•×¨×“</button>
        <button class="nav-btn" onclick="showPage('shifts')" id="nav-shifts">ğŸ• ××©××¨×•×ª</button>
        <button class="nav-btn" onclick="showPage('export')" id="nav-export">ğŸ“¤ ×™×™×¦×•×</button>
        <button class="nav-btn" onclick="showPage('profile')" id="nav-profile">âš™ï¸ ×¤×¨×•×¤×™×œ</button>
        <button class="nav-btn" onclick="showPage('admin')" id="nav-admin">ğŸ” × ×™×”×•×œ</button>
      </nav>
      <div class="header-user">
        <div class="user-avatar" id="header-avatar">×</div>
        <div class="user-name" id="header-name">××©×ª××©</div>
        <button class="btn btn-glass btn-sm" onclick="doLogout()">×™×¦×™××”</button>
      </div>
    </header>

    <div class="app-content">

      <!-- DASHBOARD PAGE -->
      <div class="page active" id="page-dashboard">
        <div style="padding: 20px 0 16px; display:flex; align-items:center; justify-content:space-between;">
          <div>
            <div style="font-size:24px; font-weight:800;">×©×œ×•×, <span id="dash-name">â€”</span> ğŸ‘‹</div>
            <div style="color:var(--text-muted); font-size:14px; margin-top:4px;" id="dash-month">â€”</div>
          </div>
          <button class="btn btn-primary" style="width:auto; padding: 12px 22px;" onclick="openAddShift()">+ ××©××¨×ª ×—×“×©×”</button>
        </div>

        <div class="stats-grid">
          <div class="glass stat-card purple">
            <div class="stat-icon">â°</div>
            <div class="stat-label">×©×¢×•×ª ×”×—×•×“×©</div>
            <div class="stat-value" id="stat-hours">0</div>
            <div class="stat-sub">×©×¢×•×ª ×‘×•×¦×¢×•</div>
          </div>
          <div class="glass stat-card pink">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-label">×©×›×¨ ×‘×¨×•×˜×•</div>
            <div class="stat-value" id="stat-gross">â‚ª0</div>
            <div class="stat-sub">×œ×¤× ×™ × ×™×›×•×™×™×</div>
          </div>
          <div class="glass stat-card blue">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-label">××©××¨×•×ª</div>
            <div class="stat-value" id="stat-shifts">0</div>
            <div class="stat-sub">×”×—×•×“×©</div>
          </div>
          <div class="glass stat-card green">
            <div class="stat-icon">ğŸŒ™</div>
            <div class="stat-label">××©××¨×•×ª ×œ×™×œ×”</div>
            <div class="stat-value" id="stat-night">0</div>
            <div class="stat-sub">×œ×™×œ×•×ª ×”×—×•×“×©</div>
          </div>
        </div>

        <!-- Recent shifts -->
        <div class="section-header">
          <div class="section-title">××©××¨×•×ª ××—×¨×•× ×•×ª</div>
        </div>
        <div class="shift-list" id="recent-shifts-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸŒ™</div>
            <div class="empty-text">×¢×“×™×™×Ÿ ××™×Ÿ ××©××¨×•×ª</div>
            <div class="empty-sub">×”×•×¡×£/×™ ××ª ×”××©××¨×ª ×”×¨××©×•× ×” ×©×œ×š</div>
          </div>
        </div>
      </div>

      <!-- SHIFTS PAGE -->
      <div class="page" id="page-shifts">
        <div style="padding: 20px 0 16px; display:flex; align-items:center; justify-content:space-between;">
          <div style="font-size:22px; font-weight:800;">×›×œ ×”××©××¨×•×ª</div>
          <div style="display:flex; gap:10px; align-items:center;">
            <select class="form-input" style="width:auto; padding: 10px 16px;" id="filter-month" onchange="renderShiftsPage()">
            </select>
            <button class="btn btn-primary" style="width:auto; padding: 12px 22px;" onclick="openAddShift()">+ ×”×•×¡×£</button>
          </div>
        </div>
        <div class="shift-list" id="all-shifts-list"></div>
      </div>

      <!-- EXPORT PAGE -->
      <div class="page" id="page-export">
        <div style="padding: 20px 0 16px;">
          <div style="font-size:22px; font-weight:800;">×™×™×¦×•× ×“×•×— ×—×•×“×©×™</div>
          <div style="color:var(--text-muted); font-size:14px; margin-top:4px;">×™×¦× ×“×•×— Excel/CSV ××•×›×Ÿ ×œ×”×’×©×” ×œ×¤×™ ××‘× ×” ×”×“×•×— ×”×¨×©××™</div>
        </div>

        <div class="glass" style="padding:28px; margin-bottom:20px;">
          <div class="form-group">
            <label class="form-label">×‘×—×¨ ×—×•×“×© ×œ×™×™×¦×•×</label>
            <select class="form-input" id="export-month" style="max-width:300px;"></select>
          </div>

          <div class="glass-dark" style="padding:20px; margin-top:16px; margin-bottom:20px;" id="export-preview">
            <div style="font-size:14px; font-weight:600; margin-bottom:12px;">×ª×¦×•×’×” ××§×“×™××”</div>
            <div id="export-preview-content" style="color:var(--text-muted); font-size:13px;">×‘×—×¨ ×—×•×“×© ×œ×ª×¦×•×’×” ××§×“×™××”</div>
          </div>

          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="btn btn-primary" style="width:auto;" onclick="exportCSV()">â¬‡ï¸ ×™×™×¦×•× CSV</button>
            <button class="btn btn-glass" onclick="exportExcelLike()">ğŸ“Š ×™×™×¦×•× Excel</button>
          </div>
        </div>
      </div>

      <!-- PROFILE PAGE -->
      <div class="page" id="page-profile">
        <div style="padding: 20px 0 16px;">
          <div style="font-size:22px; font-weight:800;">×¤×¨×•×¤×™×œ ×•×”×’×“×¨×•×ª</div>
        </div>

        <div class="glass" style="padding:28px; margin-bottom:20px;">
          <div class="settings-section">
            <div class="settings-label">×¤×¨×˜×™× ××™×©×™×™×</div>
            <div class="form-group">
              <label class="form-label">×©× ××œ×</label>
              <input type="text" class="form-input" id="profile-name" placeholder="×©× ××œ×">
            </div>
            <div class="form-group">
              <label class="form-label">×•×ª×§ (×—×•×“×©×™× ××ª×—×™×œ×ª ×¢×‘×•×“×”)</label>
              <input type="number" class="form-input" id="profile-seniority" placeholder="0" min="0">
            </div>
          </div>

          <div class="settings-section">
            <div class="settings-label">×©×›×¨ ×‘×¡×™×¡ ×œ×¤×™ ×•×ª×§</div>
            <div class="glass-dark" style="padding:16px;">
              <div class="salary-row">
                <span>0â€“6 ×—×•×“×©×™×</span><span>â‚ª37 ×œ×©×¢×”</span>
              </div>
              <div class="salary-row">
                <span>6â€“12 ×—×•×“×©×™×</span><span>â‚ª37.5 ×œ×©×¢×”</span>
              </div>
              <div class="salary-row">
                <span>×©× ×” ×©× ×™×™×”</span><span>â‚ª39 ×œ×©×¢×”</span>
              </div>
              <div class="salary-row">
                <span style="color:var(--success)">×©× ×” ×©×œ×™×©×™×ª+</span><span style="color:var(--success)">â‚ª40 ×œ×©×¢×”</span>
              </div>
            </div>
            <div style="margin-top:10px; padding: 12px 16px; background:rgba(124,92,252,0.12); border-radius:10px; font-size:14px;">
              <span style="color:var(--text-muted)">×ª×¢×¨×™×£ ×©×œ×š ×”× ×•×›×—×™: </span>
              <strong id="profile-rate" style="color:var(--accent)">â€”</strong>
            </div>
          </div>

          <button class="btn btn-primary" style="width:auto;" onclick="saveProfile()">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
        </div>
      </div>

      <!-- ADMIN PAGE -->
      <div class="page" id="page-admin">
        <div style="padding: 20px 0 16px;">
          <div style="font-size:22px; font-weight:800;">ğŸ” ×¤×× ×œ × ×™×”×•×œ</div>
        </div>

        <div class="glass admin-gate" id="admin-gate">
          <div class="admin-icon">ğŸ›¡ï¸</div>
          <div class="admin-title">××–×•×¨ ××•×’×Ÿ</div>
          <div class="admin-sub">×”×›× ×¡ ×¡×™×¡××ª ×× ×”×œ ×œ×”××©×š</div>
          <div class="form-group" style="max-width:300px; margin:0 auto 16px;">
            <input type="password" class="form-input" id="admin-password" placeholder="×¡×™×¡××ª ×× ×”×œ" onkeypress="if(event.key==='Enter') checkAdminPass()">
          </div>
          <button class="btn btn-primary" style="max-width:200px;" onclick="checkAdminPass()">×›× ×™×¡×”</button>
        </div>

        <div id="admin-panel" style="display:none;">
          <div class="glass" style="padding:24px; margin-bottom:20px;">
            <div class="section-header">
              <div class="section-title">ğŸ‘¥ ××©×ª××©×™ ×”××¢×¨×›×ª</div>
              <button class="btn btn-glass btn-sm" onclick="loadAdminUsers()">ğŸ”„ ×¨×¢× ×Ÿ</button>
            </div>
            <div id="admin-users-list">
              <div style="text-align:center; color:var(--text-muted); padding:20px;">×˜×•×¢×Ÿ...</div>
            </div>
          </div>

          <div class="glass" style="padding:24px;">
            <div class="section-title" style="margin-bottom:16px;">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¢×¨×›×ª</div>
            <div id="admin-stats" style="color:var(--text-muted); font-size:14px;">×˜×•×¢×Ÿ...</div>
          </div>
        </div>
      </div>

    </div><!-- end app-content -->
  </div><!-- end main-app -->

</div><!-- end app -->

<!-- ADD SHIFT MODAL -->
<div class="modal-overlay" id="modal-add-shift">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title" id="modal-shift-title">â• ×”×•×¡×¤×ª ××©××¨×ª</div>
      <button class="close-btn" onclick="closeModal()">âœ•</button>
    </div>

    <input type="hidden" id="edit-shift-id">

    <div class="form-group">
      <label class="form-label">×ª××¨×™×š</label>
      <input type="date" class="form-input" id="shift-date">
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
      <div class="form-group">
        <label class="form-label">×©×¢×ª ×›× ×™×¡×”</label>
        <input type="time" class="form-input" id="shift-start">
      </div>
      <div class="form-group">
        <label class="form-label">×©×¢×ª ×™×¦×™××”</label>
        <input type="time" class="form-input" id="shift-end">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">×¡×•×’ ××©××¨×ª</label>
      <select class="form-input" id="shift-type" onchange="updateSalaryPreview()">
        <option value="×™×•××™×ª">×™×•××™×ª (16:00â€“22:00)</option>
        <option value="×œ×™×œ×”">×œ×™×œ×” (××œ××”)</option>
        <option value="××œ××”">××œ××” (×œ×™× ×”)</option>
        <option value="×©×‘×ª">×©×‘×ª</option>
        <option value="×—×’">×—×’</option>
        <option value="×”×›×©×¨×”">×”×›×©×¨×”</option>
        <option value="×™×©×™×‘×ª_×¦×•×•×ª">×™×©×™×‘×ª ×¦×•×•×ª</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
      <input type="text" class="form-input" id="shift-notes" placeholder="×”×¢×¨×•×ª ×¢×œ ×”××©××¨×ª...">
    </div>

    <div class="salary-preview" id="salary-preview">
      <div style="font-size:13px; font-weight:600; margin-bottom:10px; color:var(--text-muted);">ğŸ’° ×ª×—×©×™×‘ ×©×›×¨ ××•×§×“×</div>
      <div id="salary-preview-content"></div>
    </div>

    <div style="display:flex; gap:10px; margin-top:20px;">
      <button class="btn btn-primary" onclick="saveShift()" id="save-shift-btn">×©××•×¨ ××©××¨×ª</button>
      <button class="btn btn-glass" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, getDoc, query, where, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyD5Ma2GAqiPFKurMedUgU6Qgl-qk_Uop-s",
  authDomain: "beit-dror1.firebaseapp.com",
  databaseURL: "https://beit-dror1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "beit-dror1",
  storageBucket: "beit-dror1.firebasestorage.app",
  messagingSenderId: "397103626096",
  appId: "1:397103626096:web:85eb0db81a90320bc201b5",
  measurementId: "G-5EVL2ML38Y"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ============================================================
// SALARY ENGINE â€” Based on collective agreement (××•×ª×•×ª 2025)
// ============================================================
function getHourlyRate(seniority) {
  const months = parseInt(seniority) || 0;
  if (months < 6) return 37;
  if (months < 12) return 37.5;
  if (months < 24) return 39;
  return 40;
}

function parseTime(timeStr) {
  if (!timeStr) return null;
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
}

function minutesToHours(m) { return m / 60; }

function calcShiftPay(startTime, endTime, shiftType, seniority) {
  const rate = getHourlyRate(seniority);
  let result = { regularHours: 0, nightHours: 0, overtimeHours: 0, totalPay: 0, breakdown: [] };

  if (!startTime || !endTime) return result;

  let startMin = parseTime(startTime);
  let endMin = parseTime(endTime);
  if (endMin <= startMin) endMin += 24 * 60; // overnight

  const totalMinutes = endMin - startMin;
  let hours = minutesToHours(totalMinutes);

  // Special shift types
  if (shiftType === '×™×©×™×‘×ª_×¦×•×•×ª' || shiftType === '×”×›×©×¨×”') {
    result.regularHours = hours;
    result.totalPay = hours * rate;
    result.breakdown = [{ label: '×©×¢×•×ª ×”×›×©×¨×”/×™×©×™×‘×”', hours: +hours.toFixed(2), pay: +(hours * rate).toFixed(2) }];
    return result;
  }

  if (shiftType === '×©×‘×ª') {
    const shabbatRate = rate * 1.5;
    result.regularHours = hours;
    result.totalPay = hours * shabbatRate;
    result.breakdown = [{ label: '×©×¢×•×ª ×©×‘×ª (150%)', hours: +hours.toFixed(2), pay: +(hours * shabbatRate).toFixed(2) }];
    return result;
  }

  if (shiftType === '×—×’') {
    const holidayRate = rate * 1.5;
    result.regularHours = hours;
    result.totalPay = hours * holidayRate;
    result.breakdown = [{ label: '×©×¢×•×ª ×—×’ (150%)', hours: +hours.toFixed(2), pay: +(hours * holidayRate).toFixed(2) }];
    return result;
  }

  // For full/night/day shifts â€” apply time-of-day rules per agreement section 17
  // Hours 16:00â€“22:00 â†’ regular work
  // Hours 22:00â€“23:00 â†’ not counted as work for pay
  // Hours 23:00â€“01:00 â†’ sleeping duty (minimum pay if applicable)
  // Hours 01:00â€“06:00 â†’ sleeping (no pay unless awake)
  // Hours 06:00+ â†’ regular work

  const WORK_START = 16 * 60;  // 16:00
  const SLEEP_START = 22 * 60; // 22:00
  const SLEEP_GAP = 23 * 60;   // 23:00 (gap 22â€“23 not paid)
  const NIGHT_END_1 = 25 * 60; // 01:00 next day
  const MORNING = 30 * 60;     // 06:00 next day

  if (shiftType === '××œ××”' || shiftType === '×œ×™×œ×”') {
    // Full overnight shift logic
    let payableHours = 0;
    let nightBonusHours = 0;

    // Evening portion 16:00â€“22:00 (regular work hours)
    const eveningStart = Math.max(startMin, WORK_START);
    const eveningEnd = Math.min(endMin, SLEEP_START);
    if (eveningEnd > eveningStart) {
      const h = minutesToHours(eveningEnd - eveningStart);
      payableHours += h;
      result.breakdown.push({ label: '×©×¢×•×ª ×¢×¨×‘ (16-22)', hours: +h.toFixed(2), pay: +(h * rate).toFixed(2) });
    }

    // 22:00â€“23:00 not paid
    // 23:00â€“01:00 night duty (full pay)
    const nightStart = Math.max(startMin, SLEEP_GAP);
    const nightEnd = Math.min(endMin, NIGHT_END_1);
    if (nightEnd > nightStart) {
      const h = minutesToHours(nightEnd - nightStart);
      payableHours += h;
      result.breakdown.push({ label: '×©×¢×•×ª ×œ×™×œ×” (23-01)', hours: +h.toFixed(2), pay: +(h * rate).toFixed(2) });
    }

    // Morning from 06:00 (regular)
    if (endMin > MORNING) {
      const morningStart = Math.max(startMin, MORNING);
      const h = minutesToHours(endMin - morningStart);
      payableHours += h;
      result.breakdown.push({ label: '×©×¢×•×ª ×‘×•×§×¨ (06+)', hours: +h.toFixed(2), pay: +(h * rate).toFixed(2) });
    }

    result.regularHours = payableHours;
    result.totalPay = payableHours * rate;

    // Overtime: if total payable > 8.3h â†’ first 1.25x, then 1.5x (section 9.8)
    if (payableHours > 8.3) {
      const overtime = payableHours - 8.3;
      const regularPay = 8.3 * rate;
      let overtimePay = 0;
      if (overtime <= 2) {
        overtimePay = overtime * rate * 1.25;
        result.breakdown.push({ label: '×©×¢"×  125%', hours: +overtime.toFixed(2), pay: +overtimePay.toFixed(2) });
      } else {
        const extra1 = 2 * rate * 1.25;
        const extra2 = (overtime - 2) * rate * 1.5;
        overtimePay = extra1 + extra2;
        result.breakdown.push({ label: '×©×¢"×  125% (2×©)', hours: 2, pay: +extra1.toFixed(2) });
        result.breakdown.push({ label: '×©×¢"×  150%', hours: +(overtime - 2).toFixed(2), pay: +extra2.toFixed(2) });
      }
      result.overtimeHours = overtime;
      result.totalPay = regularPay + overtimePay;
    }

  } else {
    // Day shift â€” simpler calculation
    if (hours > 8.3) {
      const overtime = hours - 8.3;
      const regularPay = 8.3 * rate;
      let overtimePay = 0;
      if (overtime <= 2) {
        overtimePay = overtime * rate * 1.25;
        result.breakdown = [
          { label: '×©×¢×•×ª ×¨×’×™×œ×•×ª (8.3)', hours: 8.3, pay: +regularPay.toFixed(2) },
          { label: '×©×¢"×  125%', hours: +overtime.toFixed(2), pay: +overtimePay.toFixed(2) }
        ];
      } else {
        const e1 = 2 * rate * 1.25;
        const e2 = (overtime - 2) * rate * 1.5;
        overtimePay = e1 + e2;
        result.breakdown = [
          { label: '×©×¢×•×ª ×¨×’×™×œ×•×ª', hours: 8.3, pay: +regularPay.toFixed(2) },
          { label: '×©×¢"×  125%', hours: 2, pay: +e1.toFixed(2) },
          { label: '×©×¢"×  150%', hours: +(overtime - 2).toFixed(2), pay: +e2.toFixed(2) }
        ];
      }
      result.regularHours = 8.3;
      result.overtimeHours = overtime;
      result.totalPay = regularPay + overtimePay;
    } else {
      result.regularHours = hours;
      result.totalPay = hours * rate;
      result.breakdown = [{ label: '×©×¢×•×ª ×¢×‘×•×“×”', hours: +hours.toFixed(2), pay: +(hours * rate).toFixed(2) }];
    }
  }

  result.totalPay = +result.totalPay.toFixed(2);
  return result;
}

// ============================================================
// APP STATE
// ============================================================
window._state = {
  user: null,
  userProfile: { name: '', seniority: 0 },
  shifts: [],
  adminAuthed: false
};

// ============================================================
// AUTH
// ============================================================
window.switchAuthTab = (tab) => {
  document.querySelectorAll('.auth-tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0 && tab === 'login') || (i === 1 && tab === 'register'));
  });
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
};

window.doLogin = async () => {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-password').value;
  if (!email || !pass) return showNotif('×× × ××œ× ××™××™×™×œ ×•×¡×™×¡××”', 'error');
  const btn = document.getElementById('login-btn');
  btn.innerHTML = '<div class="spinner"></div>';
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch (e) {
    let msg = '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª';
    if (e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password') msg = '××™××™×™×œ ××• ×¡×™×¡××” ×©×’×•×™×™×';
    if (e.code === 'auth/user-not-found') msg = '××©×ª××© ×œ× × ××¦×';
    showNotif(msg, 'error');
    btn.innerHTML = '<span>×›× ×™×¡×” ×œ××¢×¨×›×ª</span>';
  }
};

window.doRegister = async () => {
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-password').value;
  const seniority = parseInt(document.getElementById('reg-seniority').value) || 0;
  if (!name || !email || !pass) return showNotif('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error');
  if (pass.length < 6) return showNotif('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×', 'error');
  const btn = document.getElementById('reg-btn');
  btn.innerHTML = '<div class="spinner"></div>';
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await setDoc(doc(db, 'users', cred.user.uid), {
      name, email, seniority,
      createdAt: new Date().toISOString()
    });
    showNotif('×”×—×©×‘×•×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');
  } catch (e) {
    let msg = '×©×’×™××” ×‘×™×¦×™×¨×ª ×—×©×‘×•×Ÿ';
    if (e.code === 'auth/email-already-in-use') msg = '×”××™××™×™×œ ×›×‘×¨ ×¨×©×•× ×‘××¢×¨×›×ª';
    showNotif(msg, 'error');
    btn.innerHTML = '<span>×™×¦×™×¨×ª ×—×©×‘×•×Ÿ</span>';
  }
};

window.doLogout = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, async (user) => {
  if (user) {
    window._state.user = user;
    await loadUserProfile(user.uid);
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    initializeApp2();
  } else {
    window._state.user = null;
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('main-app').style.display = 'none';
  }
});

// ============================================================
// USER PROFILE
// ============================================================
async function loadUserProfile(uid) {
  try {
    const snap = await getDoc(doc(db, 'users', uid));
    if (snap.exists()) {
      window._state.userProfile = snap.data();
    }
  } catch (e) {}
}

window.saveProfile = async () => {
  const name = document.getElementById('profile-name').value.trim();
  const seniority = parseInt(document.getElementById('profile-seniority').value) || 0;
  try {
    await updateDoc(doc(db, 'users', window._state.user.uid), { name, seniority });
    window._state.userProfile.name = name;
    window._state.userProfile.seniority = seniority;
    updateHeaderUI();
    showNotif('×”×¤×¨×•×¤×™×œ × ×©××¨!', 'success');
    updateProfilePage();
  } catch (e) {
    showNotif('×©×’×™××” ×‘×©××™×¨×”', 'error');
  }
};

// ============================================================
// INIT
// ============================================================
async function initializeApp2() {
  updateHeaderUI();
  await loadShifts();
  populateMonthFilters();
  renderDashboard();
  renderShiftsPage();
  renderExportPage();
  updateProfilePage();
}

function updateHeaderUI() {
  const name = window._state.userProfile?.name || window._state.user?.email || '××©×ª××©';
  document.getElementById('header-name').textContent = name.split(' ')[0];
  document.getElementById('header-avatar').textContent = name.charAt(0).toUpperCase();
  document.getElementById('dash-name').textContent = name.split(' ')[0];
  const now = new Date();
  document.getElementById('dash-month').textContent = now.toLocaleDateString('he-IL', { year: 'numeric', month: 'long' });
}

// ============================================================
// SHIFTS CRUD
// ============================================================
async function loadShifts() {
  try {
    const q = query(
      collection(db, 'shifts'),
      where('uid', '==', window._state.user.uid),
      orderBy('date', 'desc')
    );
    const snap = await getDocs(q);
    window._state.shifts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch (e) {
    // Index may not be ready, try without orderBy
    try {
      const q2 = query(collection(db, 'shifts'), where('uid', '==', window._state.user.uid));
      const snap = await getDocs(q2);
      window._state.shifts = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => b.date.localeCompare(a.date));
    } catch (e2) {}
  }
}

window.openAddShift = () => {
  document.getElementById('modal-shift-title').textContent = 'â• ×”×•×¡×¤×ª ××©××¨×ª';
  document.getElementById('edit-shift-id').value = '';
  document.getElementById('shift-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('shift-start').value = '16:00';
  document.getElementById('shift-end').value = '08:00';
  document.getElementById('shift-type').value = '×™×•××™×ª';
  document.getElementById('shift-notes').value = '';
  document.getElementById('save-shift-btn').textContent = '×©××•×¨ ××©××¨×ª';
  updateSalaryPreview();
  document.getElementById('modal-add-shift').classList.add('open');
};

window.openEditShift = (id) => {
  const shift = window._state.shifts.find(s => s.id === id);
  if (!shift) return;
  document.getElementById('modal-shift-title').textContent = 'âœï¸ ×¢×¨×™×›×ª ××©××¨×ª';
  document.getElementById('edit-shift-id').value = id;
  document.getElementById('shift-date').value = shift.date;
  document.getElementById('shift-start').value = shift.startTime;
  document.getElementById('shift-end').value = shift.endTime;
  document.getElementById('shift-type').value = shift.shiftType;
  document.getElementById('shift-notes').value = shift.notes || '';
  document.getElementById('save-shift-btn').textContent = '×¢×“×›×Ÿ ××©××¨×ª';
  updateSalaryPreview();
  document.getElementById('modal-add-shift').classList.add('open');
};

window.closeModal = () => {
  document.getElementById('modal-add-shift').classList.remove('open');
};

window.saveShift = async () => {
  const editId = document.getElementById('edit-shift-id').value;
  const date = document.getElementById('shift-date').value;
  const startTime = document.getElementById('shift-start').value;
  const endTime = document.getElementById('shift-end').value;
  const shiftType = document.getElementById('shift-type').value;
  const notes = document.getElementById('shift-notes').value.trim();

  if (!date || !startTime || !endTime) return showNotif('×× × ××œ× ×ª××¨×™×š ×•×©×¢×•×ª', 'error');

  const seniority = window._state.userProfile?.seniority || 0;
  const calc = calcShiftPay(startTime, endTime, shiftType, seniority);

  let startMin = parseTime(startTime);
  let endMin = parseTime(endTime);
  if (endMin <= startMin) endMin += 24 * 60;
  const durationHours = (endMin - startMin) / 60;

  const shiftData = {
    uid: window._state.user.uid,
    date, startTime, endTime, shiftType, notes,
    durationHours: +durationHours.toFixed(2),
    calculatedPay: calc.totalPay,
    payBreakdown: calc.breakdown,
    month: date.substring(0, 7)
  };

  const btn = document.getElementById('save-shift-btn');
  btn.innerHTML = '<div class="spinner"></div>';

  try {
    if (editId) {
      await updateDoc(doc(db, 'shifts', editId), shiftData);
      const idx = window._state.shifts.findIndex(s => s.id === editId);
      if (idx >= 0) window._state.shifts[idx] = { id: editId, ...shiftData };
      showNotif('×”××©××¨×ª ×¢×•×“×›× ×”!', 'success');
    } else {
      const ref = await addDoc(collection(db, 'shifts'), shiftData);
      window._state.shifts.unshift({ id: ref.id, ...shiftData });
      showNotif('×”××©××¨×ª × ×•×¡×¤×”!', 'success');
    }
    closeModal();
    renderDashboard();
    renderShiftsPage();
  } catch (e) {
    showNotif('×©×’×™××” ×‘×©××™×¨×”: ' + e.message, 'error');
  }
  btn.textContent = editId ? '×¢×“×›×Ÿ ××©××¨×ª' : '×©××•×¨ ××©××¨×ª';
};

window.deleteShift = async (id) => {
  if (!confirm('×œ××—×•×§ ××©××¨×ª ×–×•?')) return;
  try {
    await deleteDoc(doc(db, 'shifts', id));
    window._state.shifts = window._state.shifts.filter(s => s.id !== id);
    renderDashboard();
    renderShiftsPage();
    showNotif('×”××©××¨×ª × ××—×§×”', 'success');
  } catch (e) {
    showNotif('×©×’×™××” ×‘××—×™×§×”', 'error');
  }
};

// ============================================================
// SALARY PREVIEW in modal
// ============================================================
window.updateSalaryPreview = () => {
  const start = document.getElementById('shift-start').value;
  const end = document.getElementById('shift-end').value;
  const type = document.getElementById('shift-type').value;
  const seniority = window._state.userProfile?.seniority || 0;
  const calc = calcShiftPay(start, end, type, seniority);

  let html = '';
  calc.breakdown.forEach(b => {
    html += `<div class="salary-row"><span>${b.label} (${b.hours}×©)</span><span>â‚ª${b.pay.toFixed(0)}</span></div>`;
  });
  html += `<div class="salary-row"><span style="font-weight:700">×¡×”"×› ×œ×©××™×¨×”</span><span class="salary-total">â‚ª${calc.totalPay.toFixed(0)}</span></div>`;
  document.getElementById('salary-preview-content').innerHTML = html;
};

// ============================================================
// RENDER DASHBOARD
// ============================================================
function renderDashboard() {
  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const monthShifts = window._state.shifts.filter(s => s.month === currentMonth);

  const totalHours = monthShifts.reduce((sum, s) => sum + (s.durationHours || 0), 0);
  const totalPay = monthShifts.reduce((sum, s) => sum + (s.calculatedPay || 0), 0);
  const nightShifts = monthShifts.filter(s => s.shiftType === '×œ×™×œ×”' || s.shiftType === '××œ××”').length;

  document.getElementById('stat-hours').textContent = totalHours.toFixed(1);
  document.getElementById('stat-gross').textContent = 'â‚ª' + Math.round(totalPay).toLocaleString();
  document.getElementById('stat-shifts').textContent = monthShifts.length;
  document.getElementById('stat-night').textContent = nightShifts;

  // Recent shifts (last 5)
  const recent = window._state.shifts.slice(0, 5);
  const container = document.getElementById('recent-shifts-list');
  if (recent.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸŒ™</div><div class="empty-text">×¢×“×™×™×Ÿ ××™×Ÿ ××©××¨×•×ª</div><div class="empty-sub">×”×•×¡×£/×™ ××ª ×”××©××¨×ª ×”×¨××©×•× ×” ×©×œ×š</div></div>`;
  } else {
    container.innerHTML = recent.map(s => renderShiftItem(s)).join('');
  }
}

// ============================================================
// RENDER SHIFTS PAGE
// ============================================================
function populateMonthFilters() {
  const months = [...new Set(window._state.shifts.map(s => s.month))].sort().reverse();
  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  if (!months.includes(currentMonth)) months.unshift(currentMonth);

  const heMonths = { '01':'×™× ×•××¨','02':'×¤×‘×¨×•××¨','03':'××¨×¥','04':'××¤×¨×™×œ','05':'×××™','06':'×™×•× ×™','07':'×™×•×œ×™','08':'××•×’×•×¡×˜','09':'×¡×¤×˜××‘×¨','10':'××•×§×˜×•×‘×¨','11':'× ×•×‘××‘×¨','12':'×“×¦××‘×¨' };

  ['filter-month', 'export-month'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = months.map(m => {
      const [y, mo] = m.split('-');
      return `<option value="${m}">${heMonths[mo]} ${y}</option>`;
    }).join('');
  });
}

window.renderShiftsPage = () => {
  const month = document.getElementById('filter-month')?.value || '';
  const filtered = month ? window._state.shifts.filter(s => s.month === month) : window._state.shifts;
  const container = document.getElementById('all-shifts-list');
  if (filtered.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">××™×Ÿ ××©××¨×•×ª ×‘×—×•×“×© ×–×”</div></div>`;
  } else {
    container.innerHTML = filtered.map(s => renderShiftItem(s, true)).join('');
  }
};

function renderShiftItem(s, showActions = false) {
  const d = new Date(s.date);
  const day = d.getDate();
  const month = d.toLocaleDateString('he-IL', { month: 'short' });
  const badgeClass = {
    '×œ×™×œ×”': 'badge-night', '×™×•××™×ª': 'badge-day', '×©×‘×ª': 'badge-shabbat',
    '×—×’': 'badge-holiday', '×”×›×©×¨×”': 'badge-training', '×™×©×™×‘×ª_×¦×•×•×ª': 'badge-meeting',
    '××œ××”': 'badge-full'
  }[s.shiftType] || 'badge-day';

  const typeLabel = s.shiftType.replace('_', ' ');

  return `<div class="glass shift-item">
    <div class="shift-date-badge">
      <div class="shift-day">${day}</div>
      <div class="shift-month">${month}</div>
    </div>
    <div class="shift-info">
      <div><span class="shift-type-badge ${badgeClass}">${typeLabel}</span></div>
      <div class="shift-times">${s.startTime} â€“ ${s.endTime} Â· ${s.durationHours}×©${s.notes ? ' Â· ' + s.notes : ''}</div>
    </div>
    <div style="text-align:left;">
      <div class="shift-pay">â‚ª${Math.round(s.calculatedPay || 0).toLocaleString()}</div>
      <div class="shift-hours">${s.durationHours}×© ×¢×‘×•×“×”</div>
    </div>
    <div class="shift-actions">
      <button class="btn btn-glass btn-sm" onclick="openEditShift('${s.id}')">âœï¸</button>
      <button class="btn btn-danger btn-sm" onclick="deleteShift('${s.id}')">ğŸ—‘ï¸</button>
    </div>
  </div>`;
}

// ============================================================
// EXPORT
// ============================================================
window.renderExportPage = () => {
  const month = document.getElementById('export-month')?.value;
  if (!month) return;
  const shifts = window._state.shifts.filter(s => s.month === month);
  if (shifts.length === 0) {
    document.getElementById('export-preview-content').innerHTML = '<span style="color:var(--text-muted)">××™×Ÿ ××©××¨×•×ª ×‘×—×•×“×© ×–×”</span>';
    return;
  }
  const name = window._state.userProfile?.name || '';
  const totalHours = shifts.reduce((sum, s) => sum + (s.durationHours || 0), 0);
  const totalPay = shifts.reduce((sum, s) => sum + (s.calculatedPay || 0), 0);

  document.getElementById('export-preview-content').innerHTML = `
    <div style="margin-bottom:8px;"><strong>${name}</strong> â€” ${month}</div>
    <div style="color:var(--text-muted)">×¡×”"×› ××©××¨×•×ª: ${shifts.length} | ×¡×”"×› ×©×¢×•×ª: ${totalHours.toFixed(2)} | ×¡×”"×› ×©×›×¨: â‚ª${Math.round(totalPay).toLocaleString()}</div>
  `;
};

document.getElementById('export-month')?.addEventListener('change', renderExportPage);

window.exportCSV = () => {
  const month = document.getElementById('export-month').value;
  const shifts = window._state.shifts.filter(s => s.month === month);
  const name = window._state.userProfile?.name || '×¢×•×‘×“';

  let csv = '\uFEFF'; // BOM for Hebrew
  csv += `×¡×™×›×•× ×©×¢×•×ª\r\n${name}\r\n`;
  csv += '×ª××¨×™×š,×›× ×™×¡×” ×‘××¢×¨×›×ª,×ª×™×§×•×Ÿ ×›× ×™×¡×”,×™×¦×™××” ×‘××¢×¨×›×ª,×ª×™×§×•×Ÿ ×™×¦×™××”,×¡×•×’ ××©××¨×ª,×”×¢×¨×•×ª,×¡×™×›×•× ×–××Ÿ,×©×›×¨\r\n';

  shifts.sort((a, b) => a.date.localeCompare(b.date)).forEach(s => {
    csv += `${s.date},${s.startTime},,${s.endTime},,${s.shiftType.replace('_',' ')},${s.notes || ''},${s.durationHours},${s.calculatedPay}\r\n`;
  });

  const totalH = shifts.reduce((sum, s) => sum + (s.durationHours || 0), 0);
  const totalP = shifts.reduce((sum, s) => sum + (s.calculatedPay || 0), 0);
  csv += `,,,,,,×¡×”"×›,${totalH.toFixed(2)},${totalP.toFixed(2)}\r\n`;

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `×“×•×—_×©×¢×•×ª_${name}_${month}.csv`;
  a.click();
  showNotif('×”×“×•×— ×™×•×¦× ×‘×”×¦×œ×—×”!', 'success');
};

window.exportExcelLike = () => exportCSV(); // Same CSV works in Excel with .csv extension

// ============================================================
// PROFILE PAGE
// ============================================================
window.updateProfilePage = () => {
  const p = window._state.userProfile;
  document.getElementById('profile-name').value = p?.name || '';
  document.getElementById('profile-seniority').value = p?.seniority || 0;
  const rate = getHourlyRate(p?.seniority || 0);
  document.getElementById('profile-rate').textContent = `â‚ª${rate} ×œ×©×¢×”`;
};

// ============================================================
// ADMIN
// ============================================================
// Admin password is stored as a hash concept â€” not plaintext in DOM
// The password "1414" is checked via a simple obfuscated comparison
window.checkAdminPass = () => {
  const pass = document.getElementById('admin-password').value;
  // Simple hash-like check: sum of char codes === expected value
  const expected = 49 + 52 + 49 + 52; // "1414" char codes
  const actual = pass.split('').reduce((s, c) => s + c.charCodeAt(0), 0);
  if (pass.length === 4 && actual === expected) {
    window._state.adminAuthed = true;
    document.getElementById('admin-gate').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
    loadAdminUsers();
  } else {
    showNotif('×¡×™×¡××” ×©×’×•×™×”', 'error');
    document.getElementById('admin-password').value = '';
  }
};

window.loadAdminUsers = async () => {
  const container = document.getElementById('admin-users-list');
  container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">×˜×•×¢×Ÿ...</div>';
  try {
    const snap = await getDocs(collection(db, 'users'));
    const users = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    if (users.length === 0) {
      container.innerHTML = '<div style="color:var(--text-muted); padding:12px;">××™×Ÿ ××©×ª××©×™×</div>';
      return;
    }

    container.innerHTML = users.map(u => `
      <div class="user-row">
        <div class="user-avatar" style="min-width:36px;">${(u.name || u.email || '?').charAt(0).toUpperCase()}</div>
        <div class="user-info">
          <div class="user-email">${u.name || 'â€”'}</div>
          <div class="user-meta">${u.email} Â· ×•×ª×§: ${u.seniority || 0} ×—×•×“×©×™×</div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="adminDeleteUser('${u.id}')">ğŸ—‘ï¸ ××—×§</button>
      </div>
    `).join('');

    document.getElementById('admin-stats').innerHTML = `
      <div>×¡×”"×› ××©×ª××©×™×: <strong>${users.length}</strong></div>
    `;
  } catch (e) {
    container.innerHTML = `<div style="color:var(--danger)">×©×’×™××”: ${e.message}</div>`;
  }
};

window.adminDeleteUser = async (uid) => {
  if (!confirm('×œ××—×•×§ ××©×ª××© ×–×” ×œ×¦××™×ª×•×ª?\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ×’× ××ª ×›×œ ×”××©××¨×•×ª ×©×œ×•!')) return;
  try {
    // Delete user shifts
    const q = query(collection(db, 'shifts'), where('uid', '==', uid));
    const snap = await getDocs(q);
    for (const d of snap.docs) await deleteDoc(d.ref);
    // Delete user profile
    await deleteDoc(doc(db, 'users', uid));
    showNotif('×”××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”', 'success');
    loadAdminUsers();
  } catch (e) {
    showNotif('×©×’×™××” ×‘××—×™×§×”: ' + e.message, 'error');
  }
};

// ============================================================
// NAVIGATION
// ============================================================
window.showPage = (page) => {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page)?.classList.add('active');
  document.getElementById('nav-' + page)?.classList.add('active');

  if (page === 'shifts') renderShiftsPage();
  if (page === 'export') { populateMonthFilters(); renderExportPage(); }
  if (page === 'profile') updateProfilePage();
};

// ============================================================
// NOTIFICATIONS
// ============================================================
window.showNotif = (msg, type = 'success') => {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.className = 'notif show ' + type;
  setTimeout(() => el.classList.remove('show'), 3000);
};

// Real-time preview as user changes shift times/type
document.addEventListener('DOMContentLoaded', () => {
  ['shift-start', 'shift-end', 'shift-type'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', updateSalaryPreview);
  });
});

</script>
</body>
</html>

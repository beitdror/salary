<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××©××¨×•×ª â€” ××¢×¨×›×ª × ×™×”×•×œ ×©×¢×•×ª ×•×©×›×¨</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    --glass-bg: rgba(255,255,255,0.62);
    --glass-border: rgba(255,255,255,0.85);
    --glass-shadow: 0 8px 40px rgba(120,100,200,0.13);
    --blur: blur(22px);
    --radius: 22px;
    --accent: #7c5cfc;
    --accent2: #e96bd1;
    --accent3: #3bb8f7;
    --text: #1a1535;
    --text-muted: rgba(60,50,100,0.6);
    --danger: #e0365a;
    --success: #1db87a;
    --warn: #f0a500;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Heebo', sans-serif;
    min-height: 100vh;
    background: linear-gradient(135deg, #e8e4ff 0%, #f7e8fb 35%, #e4f0ff 65%, #f0faff 100%);
    color: var(--text);
    overflow-x: hidden;
    position: relative;
  }

  /* Pride flag background - subtle, blended */
  .pride-bg {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-15deg);
    width: 160%;
    height: 55%;
    z-index: 0;
    pointer-events: none;
    opacity: 0.08;
    border-radius: 40px;
    background: linear-gradient(
      180deg,
      #FF0018 0%,    #FF0018 16.66%,
      #FFA52C 16.66%, #FFA52C 33.33%,
      #FFFF41 33.33%, #FFFF41 50%,
      #008018 50%,    #008018 66.66%,
      #0000F9 66.66%, #0000F9 83.33%,
      #86007D 83.33%, #86007D 100%
    );
  }

  /* Ambient orbs */
  .orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    pointer-events: none;
    z-index: 0;
    opacity: 0.22;
  }
  .orb1 { width: 500px; height: 500px; background: radial-gradient(circle, #b39dfa, transparent); top: -150px; right: -100px; }
  .orb2 { width: 400px; height: 400px; background: radial-gradient(circle, #f0b8ee, transparent); bottom: -100px; left: -80px; }
  .orb3 { width: 300px; height: 300px; background: radial-gradient(circle, #90d8f7, transparent); top: 40%; left: 40%; }

  /* Noise overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");
    opacity: 0.025;
    pointer-events: none;
    z-index: 1;
  }

  /* Glass card */
  .glass {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: var(--blur);
    -webkit-backdrop-filter: var(--blur);
    border-radius: var(--radius);
    box-shadow: var(--glass-shadow);
  }

  .glass-dark {
    background: rgba(120,100,200,0.08);
    border: 1px solid rgba(124,92,252,0.18);
    backdrop-filter: var(--blur);
    -webkit-backdrop-filter: var(--blur);
    border-radius: var(--radius);
    box-shadow: var(--glass-shadow);
  }

  /* Layout */
  #app { position: relative; z-index: 2; min-height: 100vh; }

  /* Auth screen */
  #auth-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
  }

  .auth-card {
    width: 100%;
    max-width: 420px;
    padding: 40px 36px;
  }

  .logo-area {
    text-align: center;
    margin-bottom: 32px;
  }

  .logo-icon {
    width: 72px;
    height: 72px;
    margin: 0 auto 16px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    box-shadow: 0 8px 32px rgba(124,92,252,0.4);
  }

  .logo-title {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .logo-sub { font-size: 14px; color: var(--text-muted); margin-top: 6px; }

  .auth-tabs {
    display: flex;
    gap: 4px;
    background: rgba(124,92,252,0.08);
    border-radius: 14px;
    padding: 4px;
    margin-bottom: 28px;
  }

  .auth-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.25s ease;
    border: none;
    background: transparent;
    font-family: 'Heebo', sans-serif;
  }

  .auth-tab.active {
    background: white;
    color: var(--accent);
    font-weight: 700;
    box-shadow: 0 2px 12px rgba(124,92,252,0.15);
  }

  /* Form inputs */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px; }

  .form-input {
    width: 100%;
    background: rgba(255,255,255,0.75);
    border: 1.5px solid rgba(124,92,252,0.2);
    border-radius: 14px;
    padding: 13px 16px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 15px;
    transition: all 0.2s ease;
    outline: none;
  }

  .form-input:focus {
    border-color: var(--accent);
    background: rgba(124,92,252,0.05);
    box-shadow: 0 0 0 3px rgba(124,92,252,0.12);
  }

  .form-input::placeholder { color: rgba(80,70,130,0.4); }

  select.form-input option { background: #f5f0ff; color: var(--text); }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 24px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
    box-shadow: 0 6px 24px rgba(124,92,252,0.4);
    width: 100%;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(124,92,252,0.5);
  }

  .btn-primary:active { transform: translateY(0); }

  .btn-glass {
    background: rgba(255,255,255,0.7);
    border: 1.5px solid rgba(124,92,252,0.25);
    color: var(--text);
    backdrop-filter: blur(8px);
  }

  .btn-glass:hover { background: rgba(255,255,255,0.9); border-color: var(--accent); }

  .btn-danger {
    background: rgba(224,54,90,0.1);
    border: 1.5px solid rgba(224,54,90,0.3);
    color: var(--danger);
  }

  .btn-danger:hover { background: rgba(224,54,90,0.2); }

  .btn-sm { padding: 8px 14px; font-size: 13px; border-radius: 10px; }

  /* Main app layout */
  #main-app { display: none; min-height: 100vh; }

  /* Header */
  .app-header {
    position: sticky;
    top: 0;
    z-index: 100;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.75);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border-bottom: 1px solid rgba(124,92,252,0.15);
    box-shadow: 0 2px 20px rgba(120,100,200,0.08);
  }

  .header-logo { font-size: 20px; font-weight: 800; letter-spacing: -0.3px; }
  .header-logo span { background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

  .header-user {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
  }

  .user-name { font-size: 14px; font-weight: 500; }

  /* Nav */
  .app-nav {
    display: flex;
    gap: 4px;
    padding: 16px 24px;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .app-nav::-webkit-scrollbar { display: none; }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 12px;
    border: 1.5px solid transparent;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    background: transparent;
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  .nav-btn.active {
    background: rgba(124,92,252,0.12);
    border-color: rgba(124,92,252,0.3);
    color: var(--accent);
    font-weight: 600;
  }

  .nav-btn:hover:not(.active) { background: rgba(124,92,252,0.06); color: var(--text); }

  /* Content */
  .app-content {
    padding: 0 24px 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* Dashboard */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    padding: 24px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: -20px;
    left: -20px;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    opacity: 0.15;
  }

  .stat-card.purple::before { background: var(--accent); }
  .stat-card.pink::before { background: var(--accent2); }
  .stat-card.blue::before { background: var(--accent3); }
  .stat-card.green::before { background: var(--success); }

  .stat-icon { font-size: 28px; margin-bottom: 12px; }
  .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .stat-value { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
  .stat-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

  /* Shift list */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-title { font-size: 18px; font-weight: 700; }

  .shift-list { display: flex; flex-direction: column; gap: 10px; }

  .shift-item {
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s;
  }

  .shift-item:hover { background: rgba(124,92,252,0.06); }

  .shift-date-badge {
    text-align: center;
    min-width: 52px;
  }

  .shift-day { font-size: 22px; font-weight: 800; }
  .shift-month { font-size: 11px; color: var(--text-muted); font-weight: 500; }

  .shift-info { flex: 1; }
  .shift-type-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .badge-night { background: rgba(92,207,252,0.2); color: var(--accent3); }
  .badge-day { background: rgba(255,213,107,0.2); color: var(--warn); }
  .badge-shabbat { background: rgba(124,92,252,0.2); color: #b39ddb; }
  .badge-holiday { background: rgba(233,107,209,0.2); color: var(--accent2); }
  .badge-training { background: rgba(92,252,160,0.2); color: var(--success); }
  .badge-meeting { background: rgba(255,92,124,0.2); color: var(--danger); }
  .badge-full { background: rgba(255,165,44,0.2); color: #FFA52C; }

  .shift-times { font-size: 13px; color: var(--text-muted); }
  .shift-pay { font-size: 18px; font-weight: 700; }
  .shift-hours { font-size: 12px; color: var(--text-muted); }

  .shift-actions { display: flex; gap: 6px; }

  /* Add shift modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.open { display: flex; }

  .modal-card {
    width: 100%;
    max-width: 520px;
    padding: 32px;
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(124,92,252,0.2);
    backdrop-filter: blur(24px);
    border-radius: var(--radius);
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(100,80,200,0.15);
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }

  .modal-title { font-size: 20px; font-weight: 700; }

  .close-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(124,92,252,0.1);
    border: none;
    color: var(--text);
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .close-btn:hover { background: rgba(224,54,90,0.15); color: var(--danger); }

  .salary-preview {
    background: rgba(124,92,252,0.06);
    border: 1.5px solid rgba(124,92,252,0.2);
    border-radius: 14px;
    padding: 16px;
    margin-top: 16px;
  }

  .salary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
  }

  .salary-row:not(:last-child) { border-bottom: 1px solid rgba(124,92,252,0.1); }
  .salary-total { font-size: 18px; font-weight: 700; color: var(--success); }

  /* Settings / Profile */
  .settings-section { margin-bottom: 24px; }
  .settings-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; }

  /* Admin panel */
  .admin-gate {
    padding: 40px;
    text-align: center;
  }

  .admin-icon { font-size: 48px; margin-bottom: 16px; }
  .admin-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
  .admin-sub { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }

  .user-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    border-radius: 14px;
    margin-bottom: 10px;
    background: rgba(124,92,252,0.05);
    border: 1.5px solid rgba(124,92,252,0.12);
  }

  .user-info { flex: 1; }
  .user-email { font-size: 14px; font-weight: 500; }
  .user-meta { font-size: 12px; color: var(--text-muted); }

  /* Export */
  .export-area {
    padding: 40px;
    text-align: center;
  }

  /* Notifications */
  .notif {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 500;
    padding: 14px 24px;
    border-radius: 14px;
    font-size: 14px;
    font-weight: 500;
    backdrop-filter: blur(16px);
    animation: slideDown 0.3s ease;
    display: none;
  }

  .notif.show { display: block; }
  .notif.success { background: rgba(29,184,122,0.12); border: 1px solid rgba(29,184,122,0.35); color: var(--success); }
  .notif.error { background: rgba(224,54,90,0.1); border: 1px solid rgba(224,54,90,0.35); color: var(--danger); }

  @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

  /* Monthly summary chart */
  .chart-container {
    padding: 24px;
    margin-bottom: 24px;
  }

  .mini-bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 6px;
    height: 80px;
  }

  .mini-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }

  .mini-bar {
    width: 100%;
    border-radius: 6px 6px 0 0;
    background: linear-gradient(180deg, var(--accent), var(--accent2));
    transition: height 0.5s ease;
    min-height: 4px;
  }

  .mini-bar-label { font-size: 10px; color: var(--text-muted); }

  /* Loading spinner */
  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Responsive */
  @media (max-width: 640px) {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 10px 6px;
    border-radius: 14px;
    border: 2px solid rgba(124,92,252,0.15);
    background: rgba(124,92,252,0.05);
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 18px;
    color: var(--text-muted);
    transition: all 0.18s ease;
    line-height: 1.2;
  }

  .type-btn span { font-size: 11px; font-weight: 600; }

  .type-btn.active {
    border-color: var(--accent);
    background: rgba(124,92,252,0.14);
    color: var(--accent);
    box-shadow: 0 2px 12px rgba(124,92,252,0.2);
  }

  .type-btn:hover:not(.active) {
    border-color: rgba(124,92,252,0.35);
    background: rgba(124,92,252,0.08);
    color: var(--text);
  }
    .app-header { padding: 12px 16px; }
    .app-content { padding: 0 16px 40px; }
    .app-nav { padding: 12px 16px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .modal-card { padding: 24px 20px; }
    .shift-pay { font-size: 15px; }
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-icon { font-size: 48px; margin-bottom: 16px; }
  .empty-text { font-size: 16px; font-weight: 500; }
  .empty-sub { font-size: 13px; margin-top: 6px; }

  /* Pride stripe accent in header */
  .pride-stripe {
    height: 3px;
    background: linear-gradient(90deg, #FF0018, #FFA52C, #FFFF41, #008018, #0000F9, #86007D);
    border-radius: 0 0 2px 2px;
    opacity: 0.6;
  }
</style>
</head>
<body>

<!-- Ambient effects -->
<div class="pride-bg"></div>
<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="orb orb3"></div>

<!-- Notification -->
<div class="notif" id="notif"></div>

<div id="app">

  <!-- AUTH SCREEN -->
  <div id="auth-screen">
    <div class="glass auth-card">
      <div class="logo-area">
        <div class="logo-icon">ğŸ•</div>
        <div class="logo-title">××©××¨×•×ª ×©×œ×™</div>
        <div class="logo-sub">××¢×¨×›×ª × ×™×”×•×œ ×©×¢×•×ª ×•×©×›×¨ ×œ×¢×•×‘×“×™×</div>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">×”×ª×—×‘×¨×•×ª</button>
        <button class="auth-tab" onclick="switchAuthTab('register')">×”×¨×©××”</button>
      </div>

      <!-- Login Form -->
      <div id="login-form">
        <div class="form-group">
          <label class="form-label">×©× ××©×ª××©</label>
          <input type="text" class="form-input" id="login-username" placeholder="×©× ××©×ª××© ×©×œ×š">
        </div>
        <div class="form-group">
          <label class="form-label">×¡×™×¡××”</label>
          <input type="password" class="form-input" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn btn-primary" onclick="doLogin()" id="login-btn">
          <span>×›× ×™×¡×” ×œ××¢×¨×›×ª</span>
        </button>
      </div>

      <!-- Register Form -->
      <div id="register-form" style="display:none">
        <div class="form-group">
          <label class="form-label">×©× ××œ×</label>
          <input type="text" class="form-input" id="reg-name" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
        </div>
        <div class="form-group">
          <label class="form-label">×©× ××©×ª××© (×›×œ ×©×, ×’× ×‘×¢×‘×¨×™×ª)</label>
          <input type="text" class="form-input" id="reg-username" placeholder="×œ××©×œ: ×“× ×”, moshe123, ×“× ×™ ×œ">
        </div>
        <div class="form-group">
          <label class="form-label">×¡×™×¡××” (×œ×¤×—×•×ª 4 ×ª×•×•×™×)</label>
          <input type="password" class="form-input" id="reg-password" placeholder="×¡×™×¡××” ×¤×©×•×˜×” ×›××• 1234">
        </div>
        <div class="form-group">
          <label class="form-label">×ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”</label>
          <input type="month" class="form-input" id="reg-start-date" placeholder="×—×•×“×© ×•×©× ×ª ×”×ª×—×œ×”">
        </div>
        <button class="btn btn-primary" onclick="doRegister()" id="reg-btn">
          <span>×™×¦×™×¨×ª ×—×©×‘×•×Ÿ</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="main-app">
    <div class="pride-stripe"></div>

    <!-- Header -->
    <header class="app-header">
      <div class="header-logo">ğŸ• <span>××©××¨×•×ª ×©×œ×™</span></div>
      <nav class="app-nav" style="padding: 0; flex: 1; justify-content: center;">
        <button class="nav-btn active" onclick="showPage('dashboard')" id="nav-dashboard">ğŸ“Š ×“××©×‘×•×¨×“</button>
        <button class="nav-btn" onclick="showPage('shifts')" id="nav-shifts">ğŸ• ××©××¨×•×ª</button>
        <button class="nav-btn" onclick="showPage('export')" id="nav-export">ğŸ“¤ ×™×™×¦×•×</button>
        <button class="nav-btn" onclick="showPage('profile')" id="nav-profile">âš™ï¸ ×¤×¨×•×¤×™×œ</button>
        <button class="nav-btn" onclick="showPage('admin')" id="nav-admin">ğŸ” × ×™×”×•×œ</button>
      </nav>
      <div class="header-user">
        <div class="user-avatar" id="header-avatar">×</div>
        <div class="user-name" id="header-name">××©×ª××©</div>
        <button class="btn btn-glass btn-sm" onclick="doLogout()">×™×¦×™××”</button>
      </div>
    </header>

    <div class="app-content">

      <!-- DASHBOARD PAGE -->
      <div class="page active" id="page-dashboard">
        <div style="padding: 20px 0 16px; display:flex; align-items:center; justify-content:space-between;">
          <div>
            <div style="font-size:24px; font-weight:800;">×©×œ×•×, <span id="dash-name">â€”</span> ğŸ‘‹</div>
            <div style="color:var(--text-muted); font-size:14px; margin-top:4px;" id="dash-month">â€”</div>
          </div>
          <button class="btn btn-primary" style="width:auto; padding: 12px 22px;" onclick="openAddShift()">+ ××©××¨×ª ×—×“×©×”</button>
        </div>

        <div class="stats-grid">
          <div class="glass stat-card purple">
            <div class="stat-icon">â°</div>
            <div class="stat-label">×©×¢×•×ª ×”×—×•×“×©</div>
            <div class="stat-value" id="stat-hours">0</div>
            <div class="stat-sub">×©×¢×•×ª ×‘×•×¦×¢×•</div>
          </div>
          <div class="glass stat-card pink">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-label">×©×›×¨ ×‘×¨×•×˜×•</div>
            <div class="stat-value" id="stat-gross">â‚ª0</div>
            <div class="stat-sub">×œ×¤× ×™ × ×™×›×•×™×™×</div>
          </div>
          <div class="glass stat-card blue">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-label">××©××¨×•×ª</div>
            <div class="stat-value" id="stat-shifts">0</div>
            <div class="stat-sub">×”×—×•×“×©</div>
          </div>
          <div class="glass stat-card green">
            <div class="stat-icon">ğŸŒ™</div>
            <div class="stat-label">××©××¨×•×ª ×œ×™×œ×”</div>
            <div class="stat-value" id="stat-night">0</div>
            <div class="stat-sub">×œ×™×œ×•×ª ×”×—×•×“×©</div>
          </div>
        </div>

        <!-- Recent shifts -->
        <div class="section-header">
          <div class="section-title">××©××¨×•×ª ××—×¨×•× ×•×ª</div>
        </div>
        <div class="shift-list" id="recent-shifts-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸŒ™</div>
            <div class="empty-text">×¢×“×™×™×Ÿ ××™×Ÿ ××©××¨×•×ª</div>
            <div class="empty-sub">×”×•×¡×£/×™ ××ª ×”××©××¨×ª ×”×¨××©×•× ×” ×©×œ×š</div>
          </div>
        </div>
      </div>

      <!-- SHIFTS PAGE -->
      <div class="page" id="page-shifts">
        <div style="padding: 20px 0 16px; display:flex; align-items:center; justify-content:space-between;">
          <div style="font-size:22px; font-weight:800;">×›×œ ×”××©××¨×•×ª</div>
          <div style="display:flex; gap:10px; align-items:center;">
            <select class="form-input" style="width:auto; padding: 10px 16px;" id="filter-month" onchange="renderShiftsPage()">
            </select>
            <button class="btn btn-primary" style="width:auto; padding: 12px 22px;" onclick="openAddShift()">+ ×”×•×¡×£</button>
          </div>
        </div>
        <div class="shift-list" id="all-shifts-list"></div>
      </div>

      <!-- EXPORT PAGE -->
      <div class="page" id="page-export">
        <div style="padding: 20px 0 16px;">
          <div style="font-size:22px; font-weight:800;">×™×™×¦×•× ×“×•×— ×—×•×“×©×™</div>
          <div style="color:var(--text-muted); font-size:14px; margin-top:4px;">×™×¦× ×“×•×— Excel/CSV ××•×›×Ÿ ×œ×”×’×©×” ×œ×¤×™ ××‘× ×” ×”×“×•×— ×”×¨×©××™</div>
        </div>

        <div class="glass" style="padding:28px; margin-bottom:20px;">
          <div class="form-group">
            <label class="form-label">×‘×—×¨ ×—×•×“×© ×œ×™×™×¦×•×</label>
            <select class="form-input" id="export-month" style="max-width:300px;"></select>
          </div>

          <div class="glass-dark" style="padding:20px; margin-top:16px; margin-bottom:20px;" id="export-preview">
            <div style="font-size:14px; font-weight:600; margin-bottom:12px;">×ª×¦×•×’×” ××§×“×™××”</div>
            <div id="export-preview-content" style="color:var(--text-muted); font-size:13px;">×‘×—×¨ ×—×•×“×© ×œ×ª×¦×•×’×” ××§×“×™××”</div>
          </div>

          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="btn btn-primary" style="width:auto;" onclick="exportCSV()">â¬‡ï¸ ×™×™×¦×•× CSV</button>
            <button class="btn btn-glass" onclick="exportExcelLike()">ğŸ“Š ×™×™×¦×•× Excel</button>
          </div>
        </div>
      </div>

      <!-- PROFILE PAGE -->
      <div class="page" id="page-profile">
        <div style="padding: 20px 0 16px;">
          <div style="font-size:22px; font-weight:800;">×¤×¨×•×¤×™×œ ×•×”×’×“×¨×•×ª</div>
        </div>

        <div class="glass" style="padding:28px; margin-bottom:20px;">
          <div class="settings-section">
            <div class="settings-label">×¤×¨×˜×™× ××™×©×™×™×</div>
            <div class="form-group">
              <label class="form-label">×©× ××œ×</label>
              <input type="text" class="form-input" id="profile-name" placeholder="×©× ××œ×">
            </div>
            <div class="form-group">
              <label class="form-label">×ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”</label>
              <input type="month" class="form-input" id="profile-start-date">
              <div style="font-size:12px; color:var(--text-muted); margin-top:6px;" id="profile-seniority-display"></div>
            </div>
          </div>

          <div class="settings-section">
            <div class="settings-label">×©×›×¨ ×‘×¡×™×¡ ×œ×¤×™ ×•×ª×§ (××ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”)</div>
            <div class="glass-dark" style="padding:16px;">
              <div class="salary-row">
                <span>0â€“6 ×—×•×“×©×™×</span><span>â‚ª37 ×œ×©×¢×”</span>
              </div>
              <div class="salary-row">
                <span>6â€“12 ×—×•×“×©×™×</span><span>â‚ª37.5 ×œ×©×¢×”</span>
              </div>
              <div class="salary-row">
                <span>×©× ×” ×©× ×™×™×”</span><span>â‚ª39 ×œ×©×¢×”</span>
              </div>
              <div class="salary-row">
                <span style="color:var(--success)">×©× ×” ×©×œ×™×©×™×ª+</span><span style="color:var(--success)">â‚ª40 ×œ×©×¢×”</span>
              </div>
            </div>
            <div style="margin-top:10px; padding: 12px 16px; background:rgba(124,92,252,0.08); border-radius:10px; font-size:14px;">
              <span style="color:var(--text-muted)">×ª×¢×¨×™×£ ×©×œ×š ×”× ×•×›×—×™: </span>
              <strong id="profile-rate" style="color:var(--accent)">â€”</strong>
            </div>
          </div>

          <button class="btn btn-primary" style="width:auto;" onclick="saveProfile()">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
        </div>
      </div>

      <!-- ADMIN PAGE -->
      <div class="page" id="page-admin">
        <div style="padding: 20px 0 16px;">
          <div style="font-size:22px; font-weight:800;">ğŸ” ×¤×× ×œ × ×™×”×•×œ</div>
        </div>

        <div class="glass admin-gate" id="admin-gate">
          <div class="admin-icon">ğŸ›¡ï¸</div>
          <div class="admin-title">××–×•×¨ ××•×’×Ÿ</div>
          <div class="admin-sub">×”×›× ×¡ ×¡×™×¡××ª ×× ×”×œ ×œ×”××©×š</div>
          <div class="form-group" style="max-width:300px; margin:0 auto 16px;">
            <input type="password" class="form-input" id="admin-password" placeholder="×¡×™×¡××ª ×× ×”×œ" onkeypress="if(event.key==='Enter') checkAdminPass()">
          </div>
          <button class="btn btn-primary" style="max-width:200px;" onclick="checkAdminPass()">×›× ×™×¡×”</button>
        </div>

        <div id="admin-panel" style="display:none;">
          <div class="glass" style="padding:24px; margin-bottom:20px;">
            <div class="section-header">
              <div class="section-title">ğŸ‘¥ ××©×ª××©×™ ×”××¢×¨×›×ª</div>
              <button class="btn btn-glass btn-sm" onclick="loadAdminUsers()">ğŸ”„ ×¨×¢× ×Ÿ</button>
            </div>
            <div id="admin-users-list">
              <div style="text-align:center; color:var(--text-muted); padding:20px;">×˜×•×¢×Ÿ...</div>
            </div>
          </div>

          <div class="glass" style="padding:24px;">
            <div class="section-title" style="margin-bottom:16px;">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¢×¨×›×ª</div>
            <div id="admin-stats" style="color:var(--text-muted); font-size:14px;">×˜×•×¢×Ÿ...</div>
          </div>
        </div>
      </div>

    </div><!-- end app-content -->
  </div><!-- end main-app -->

</div><!-- end app -->

<!-- ADD SHIFT MODAL -->
<div class="modal-overlay" id="modal-add-shift">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title" id="modal-shift-title">â• ×”×•×¡×¤×ª ××©××¨×ª</div>
      <button class="close-btn" onclick="closeModal()">âœ•</button>
    </div>

    <input type="hidden" id="edit-shift-id">

    <!-- Shift type selector -->
    <div class="form-group">
      <label class="form-label">×¡×•×’ ××©××¨×ª</label>
      <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px;" id="type-grid">
        <button class="type-btn active" data-type="××œ××”" onclick="selectType(this)">ğŸŒ™<br><span>××œ××”</span></button>
        <button class="type-btn" data-type="×™×•××™×ª" onclick="selectType(this)">â˜€ï¸<br><span>×™×•××™×ª</span></button>
        <button class="type-btn" data-type="×©×‘×ª" onclick="selectType(this)">âœ¡ï¸<br><span>×©×‘×ª</span></button>
        <button class="type-btn" data-type="×—×’" onclick="selectType(this)">ğŸ‰<br><span>×—×’</span></button>
        <button class="type-btn" data-type="×”×›×©×¨×”" onclick="selectType(this)">ğŸ“š<br><span>×”×›×©×¨×”</span></button>
        <button class="type-btn" data-type="×™×©×™×‘×ª_×¦×•×•×ª" onclick="selectType(this)">ğŸ’¬<br><span>×™×©×™×‘×ª ×¦×•×•×ª</span></button>
        <button class="type-btn" data-type="××—×¨" onclick="selectType(this)">âœï¸<br><span>××—×¨</span></button>
      </div>
    </div>

    <!-- Custom name (shown for "××—×¨") -->
    <div class="form-group" id="custom-name-group" style="display:none;">
      <label class="form-label">×©× ××•×ª×× ××™×©×™×ª</label>
      <input type="text" class="form-input" id="shift-custom-name" placeholder="×œ××©×œ: ×›×•× × ×•×ª, ×”×—×œ×¤×”...">
    </div>

    <!-- Shabbat auto-notice -->
    <div id="shabbat-notice" style="display:none; background:rgba(124,92,252,0.1); border:1.5px solid rgba(124,92,252,0.3); border-radius:12px; padding:10px 14px; font-size:13px; margin-bottom:12px;">
      âœ¡ï¸ <strong>×©×‘×ª ×–×•×”×ª×” ××•×˜×•××˜×™×ª</strong> â€” ×¡×•×’ ×”××©××¨×ª ×¢×•×“×›×Ÿ ×œ×©×‘×ª (150%)
    </div>

    <!-- Date row: for overnight shifts show both dates -->
    <div id="date-section-overnight" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
      <div class="form-group">
        <label class="form-label">×ª××¨×™×š ×›× ×™×¡×”</label>
        <input type="date" class="form-input" id="shift-date" onchange="onDateChange()">
      </div>
      <div class="form-group" id="end-date-group">
        <label class="form-label">×ª××¨×™×š ×™×¦×™××” <span style="font-size:11px; opacity:0.7;">(×××•×œ× ××•×˜×•××˜×™×ª)</span></label>
        <input type="date" class="form-input" id="shift-end-date" onchange="updateSalaryPreview()">
      </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
      <div class="form-group">
        <label class="form-label">×©×¢×ª ×›× ×™×¡×”</label>
        <input type="time" class="form-input" id="shift-start" onchange="onTimeChange()">
      </div>
      <div class="form-group">
        <label class="form-label">×©×¢×ª ×™×¦×™××”</label>
        <input type="time" class="form-input" id="shift-end" onchange="updateSalaryPreview()">
      </div>
    </div>

    <!-- Duration hint -->
    <div id="duration-hint" style="font-size:13px; color:var(--text-muted); margin-bottom:12px; padding:8px 12px; background:rgba(60,50,100,0.06); border-radius:10px;"></div>

    <div class="form-group">
      <label class="form-label">×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)</label>
      <input type="text" class="form-input" id="shift-notes" placeholder="×”×¢×¨×•×ª ×¢×œ ×”××©××¨×ª...">
    </div>

    <div class="salary-preview" id="salary-preview">
      <div style="font-size:13px; font-weight:600; margin-bottom:10px; color:var(--text-muted);">ğŸ’° ×ª×—×©×™×‘ ×©×›×¨</div>
      <div id="salary-preview-content"></div>
    </div>

    <div style="display:flex; gap:10px; margin-top:20px;">
      <button class="btn btn-primary" onclick="saveShift()" id="save-shift-btn">×©××•×¨ ××©××¨×ª</button>
      <button class="btn btn-glass" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, getDoc, query, where, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyB6YFRQw9HA-7h81uwr-xh63uJ0a2aY1C0",
  authDomain: "salary-cf07d.firebaseapp.com",
  projectId: "salary-cf07d",
  storageBucket: "salary-cf07d.firebasestorage.app",
  messagingSenderId: "168903696459",
  appId: "1:168903696459:web:597b055da737fe96eaedce",
  measurementId: "G-LTEGBTBTP8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ============================================================
// SALARY ENGINE â€” Based on collective agreement 2025
// ============================================================
function calcSeniorityMonths(startDate) {
  if (!startDate) return 0;
  const start = new Date(startDate + '-01');
  const now = new Date();
  return (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
}

function getHourlyRate(startDate) {
  const months = calcSeniorityMonths(startDate);
  if (months < 6) return 37;
  if (months < 12) return 37.5;
  if (months < 24) return 39;
  return 40;
}

// Check if a date (YYYY-MM-DD) falls on Shabbat (Friday after ~18:00 or Saturday)
function isShabbat(dateStr, timeStr) {
  if (!dateStr) return false;
  const d = new Date(dateStr);
  const day = d.getDay(); // 0=Sun,5=Fri,6=Sat
  if (day === 6) return true; // Saturday always shabbat
  if (day === 5 && timeStr) {
    // Friday evening: from ~18:00
    const [h] = timeStr.split(':').map(Number);
    if (h >= 18) return true;
  }
  return false;
}

// Next day date string
function nextDay(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  d.setDate(d.getDate() + 1);
  return d.toISOString().split('T')[0];
}

function parseTime(timeStr) {
  if (!timeStr) return null;
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
}

function minutesToHours(m) { return m / 60; }

// Total minutes between two date+time combos
function calcTotalMinutes(startDate, startTime, endDate, endTime) {
  if (!startDate || !startTime || !endDate || !endTime) return 0;
  const start = new Date(`${startDate}T${startTime}`);
  const end = new Date(`${endDate}T${endTime}`);
  return (end - start) / 60000;
}

/**
 * Main salary calculator
 * startDate/endDate = YYYY-MM-DD
 * startTime/endTime = HH:MM
 * shiftType = string
 * workStartDate = employee start date for seniority
 */
function calcShiftPay(startDate, startTime, endDate, endTime, shiftType, workStartDate) {
  const rate = getHourlyRate(workStartDate);
  let result = { regularHours: 0, overtimeHours: 0, totalPay: 0, breakdown: [], totalMinutes: 0 };

  if (!startDate || !startTime || !endDate || !endTime) return result;

  const totalMins = calcTotalMinutes(startDate, startTime, endDate, endTime);
  if (totalMins <= 0) return result;
  result.totalMinutes = totalMins;
  const totalHours = totalMins / 60;

  // --- Meetings & Training: straight pay ---
  if (shiftType === '×™×©×™×‘×ª_×¦×•×•×ª' || shiftType === '×”×›×©×¨×”' || shiftType === '××—×¨') {
    result.regularHours = totalHours;
    result.totalPay = totalHours * rate;
    result.breakdown = [{ label: '×©×¢×•×ª ×¢×‘×•×“×”', hours: +totalHours.toFixed(2), pay: +(totalHours * rate).toFixed(2) }];
    return result;
  }

  // --- Shabbat: 150% for all hours ---
  if (shiftType === '×©×‘×ª') {
    const shabbatRate = rate * 1.5;
    result.regularHours = totalHours;
    result.totalPay = totalHours * shabbatRate;
    result.breakdown = [{ label: `×©×¢×•×ª ×©×‘×ª (${totalHours.toFixed(2)}×© Ã— â‚ª${rate} Ã— 150%)`, hours: +totalHours.toFixed(2), pay: +result.totalPay.toFixed(2) }];
    return result;
  }

  // --- Holiday: 150% ---
  if (shiftType === '×—×’') {
    const holidayRate = rate * 1.5;
    result.regularHours = totalHours;
    result.totalPay = totalHours * holidayRate;
    result.breakdown = [{ label: `×©×¢×•×ª ×—×’ (${totalHours.toFixed(2)}×© Ã— â‚ª${rate} Ã— 150%)`, hours: +totalHours.toFixed(2), pay: +result.totalPay.toFixed(2) }];
    return result;
  }

  // --- Full overnight shift / night shift: apply section 17 time-of-day rules ---
  // We work in absolute minutes from midnight of startDate
  // startMin is absolute from midnight, endMin can be >24*60 for next-day end
  const startMin = parseTime(startTime);
  // endMin: calculate as total minutes from start of startDate
  const endAbsMin = startMin + totalMins;

  // Time bands (per agreement section 17):
  // 16:00â€“22:00 = regular paid work
  // 22:00â€“23:00 = NOT paid (transition gap)
  // 23:00â€“01:00 = night duty (paid, full rate)
  // 01:00â€“06:00 = sleep duty (NOT paid)
  // 06:00â€“...   = regular paid work (morning)
  // For shabbat-adjacent: if shift starts friday evening, entire shift at shabbat rate

  // Check if shift spans into Shabbat
  const startDayOfWeek = new Date(startDate).getDay();
  const endDayOfWeek = new Date(endDate).getDay();
  const endsOnSaturday = endDayOfWeek === 6;
  const startsOnFridayEvening = startDayOfWeek === 5 && parseTime(startTime) >= 18 * 60;

  if (startsOnFridayEvening || (startDayOfWeek === 6)) {
    // Full shabbat rate
    const shabbatRate = rate * 1.5;
    result.regularHours = totalHours;
    result.totalPay = totalHours * shabbatRate;
    result.breakdown = [{ label: `×©×¢×•×ª ×©×‘×ª (150%)`, hours: +totalHours.toFixed(2), pay: +result.totalPay.toFixed(2) }];
    return result;
  }

  if (shiftType === '××œ××”' || shiftType === '×œ×™×œ×”') {
    // Absolute time bands from midnight of shift start day (in minutes)
    const bands = [
      { from: 0,       to: 6*60,   paid: false, label: null },             // 00:00â€“06:00 sleep
      { from: 6*60,    to: 16*60,  paid: true,  label: '×©×¢×•×ª ×‘×•×§×¨ (06-16)' },  // 06:00â€“16:00 regular
      { from: 16*60,   to: 22*60,  paid: true,  label: '×©×¢×•×ª ×¢×¨×‘ (16-22)' },   // 16:00â€“22:00 regular
      { from: 22*60,   to: 23*60,  paid: false, label: null },             // 22:00â€“23:00 gap
      { from: 23*60,   to: 25*60,  paid: true,  label: '×©×¢×•×ª ×œ×™×œ×” (23-01)' },  // 23:00â€“01:00 night duty
      { from: 25*60,   to: 30*60,  paid: false, label: null },             // 01:00â€“06:00 sleep
      { from: 30*60,   to: 40*60,  paid: true,  label: '×©×¢×•×ª ×‘×•×§×¨ (06+)' },    // 06:00+ morning (next day)
      { from: 40*60,   to: 46*60,  paid: true,  label: '×©×¢×•×ª ×¢×¨×‘ ×™×•× ×‘\'' },   // next afternoon
    ];

    let payableHours = 0;
    const breakdownMap = {};

    for (const band of bands) {
      if (!band.paid) continue;
      const overlapStart = Math.max(startMin, band.from);
      const overlapEnd = Math.min(endAbsMin, band.to);
      if (overlapEnd > overlapStart) {
        const h = minutesToHours(overlapEnd - overlapStart);
        payableHours += h;
        if (!breakdownMap[band.label]) breakdownMap[band.label] = 0;
        breakdownMap[band.label] += h;
      }
    }

    // Build breakdown before overtime
    for (const [label, h] of Object.entries(breakdownMap)) {
      result.breakdown.push({ label, hours: +h.toFixed(2), pay: +(h * rate).toFixed(2) });
    }

    result.regularHours = payableHours;
    result.totalPay = payableHours * rate;

    // Overtime (section 9.8): >8.3h payable â†’ 125% first 2h, then 150%
    if (payableHours > 8.3) {
      const overtime = payableHours - 8.3;
      const regularPay = 8.3 * rate;
      let overtimePay = 0;
      if (overtime <= 2) {
        overtimePay = overtime * rate * 1.25;
        result.breakdown.push({ label: '×©×¢"×  125%', hours: +overtime.toFixed(2), pay: +overtimePay.toFixed(2) });
      } else {
        const e1 = 2 * rate * 1.25;
        const e2 = (overtime - 2) * rate * 1.5;
        overtimePay = e1 + e2;
        result.breakdown.push({ label: '×©×¢"×  125% (2×©)', hours: 2, pay: +e1.toFixed(2) });
        result.breakdown.push({ label: '×©×¢"×  150%', hours: +(overtime - 2).toFixed(2), pay: +e2.toFixed(2) });
      }
      result.overtimeHours = overtime;
      result.totalPay = regularPay + overtimePay;
    }

  } else {
    // Day shift â€” simple overtime
    if (totalHours > 8.3) {
      const overtime = totalHours - 8.3;
      const regularPay = 8.3 * rate;
      let overtimePay = 0;
      if (overtime <= 2) {
        overtimePay = overtime * rate * 1.25;
        result.breakdown = [
          { label: '×©×¢×•×ª ×¨×’×™×œ×•×ª', hours: 8.3, pay: +regularPay.toFixed(2) },
          { label: '×©×¢"×  125%', hours: +overtime.toFixed(2), pay: +overtimePay.toFixed(2) }
        ];
      } else {
        const e1 = 2 * rate * 1.25;
        const e2 = (overtime - 2) * rate * 1.5;
        overtimePay = e1 + e2;
        result.breakdown = [
          { label: '×©×¢×•×ª ×¨×’×™×œ×•×ª', hours: 8.3, pay: +regularPay.toFixed(2) },
          { label: '×©×¢"×  125%', hours: 2, pay: +e1.toFixed(2) },
          { label: '×©×¢"×  150%', hours: +(overtime - 2).toFixed(2), pay: +e2.toFixed(2) }
        ];
      }
      result.regularHours = 8.3;
      result.overtimeHours = overtime;
      result.totalPay = regularPay + overtimePay;
    } else {
      result.regularHours = totalHours;
      result.totalPay = totalHours * rate;
      result.breakdown = [{ label: '×©×¢×•×ª ×¢×‘×•×“×”', hours: +totalHours.toFixed(2), pay: +(totalHours * rate).toFixed(2) }];
    }
  }

  result.totalPay = +result.totalPay.toFixed(2);
  return result;
}

// ============================================================
// APP STATE
// ============================================================
window._state = {
  user: null,
  userProfile: { name: '', startDate: null },
  shifts: [],
  adminAuthed: false
};

// ============================================================
// AUTH
// ============================================================
window.switchAuthTab = (tab) => {
  document.querySelectorAll('.auth-tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0 && tab === 'login') || (i === 1 && tab === 'register'));
  });
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
};

// Simple hash for any string (including Hebrew) â†’ safe ASCII string
function hashUsername(str) {
  let hash = 5381;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) + hash) + str.charCodeAt(i);
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36);
}

window.doLogin = async () => {
  const username = document.getElementById('login-username').value.trim();
  const pass = document.getElementById('login-password').value;
  if (!username || !pass) return showNotif('×× × ××œ× ×©× ××©×ª××© ×•×¡×™×¡××”', 'error');
  // Convert any username (incl. Hebrew) to safe Firebase email
  const safeId = hashUsername(username.toLowerCase());
  const email = 'u' + safeId + '@otot.app';
  // Pad password same way as registration
  const firebasePass = pass.length < 6 ? pass + '##pad' : pass;
  const btn = document.getElementById('login-btn');
  btn.innerHTML = '<div class="spinner"></div>';
  try {
    await signInWithEmailAndPassword(auth, email, firebasePass);
  } catch (e) {
    showNotif('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
    btn.innerHTML = '<span>×›× ×™×¡×” ×œ××¢×¨×›×ª</span>';
  }
};

window.doRegister = async () => {
  const name = document.getElementById('reg-name').value.trim();
  const username = document.getElementById('reg-username').value.trim();
  const pass = document.getElementById('reg-password').value;
  const startDate = document.getElementById('reg-start-date').value; // format: YYYY-MM
  if (!name || !username || !pass) return showNotif('×× × ××œ× ×©×, ×©× ××©×ª××© ×•×¡×™×¡××”', 'error');
  if (pass.length < 4) return showNotif('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 4 ×ª×•×•×™×', 'error');
  if (!startDate) return showNotif('×× × ×‘×—×¨ ×ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”', 'error');
  // Hash any username (Hebrew/English/anything) â†’ safe Firebase email
  const safeId = hashUsername(username.toLowerCase());
  const email = 'u' + safeId + '@otot.app';
  // Pad password to 6 chars min for Firebase (internally)
  const firebasePass = pass.length < 6 ? pass + '##pad' : pass;
  const btn = document.getElementById('reg-btn');
  btn.innerHTML = '<div class="spinner"></div>';
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, firebasePass);
    await setDoc(doc(db, 'users', cred.user.uid), {
      name, username, email, startDate,
      createdAt: new Date().toISOString()
    });
    showNotif('×”×—×©×‘×•×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”! ğŸ‰', 'success');
  } catch (e) {
    let msg = '×©×’×™××” ×‘×™×¦×™×¨×ª ×—×©×‘×•×Ÿ';
    if (e.code === 'auth/email-already-in-use') msg = '×©× ×”××©×ª××© "' + username + '" ×›×‘×¨ ×ª×¤×•×¡, ×‘×—×¨ ×©× ××—×¨';
    showNotif(msg, 'error');
    btn.innerHTML = '<span>×™×¦×™×¨×ª ×—×©×‘×•×Ÿ</span>';
  }
};

window.doLogout = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, async (user) => {
  if (user) {
    window._state.user = user;
    await loadUserProfile(user.uid);
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    initializeApp2();
  } else {
    window._state.user = null;
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('main-app').style.display = 'none';
  }
});

// ============================================================
// USER PROFILE
// ============================================================
async function loadUserProfile(uid) {
  try {
    const snap = await getDoc(doc(db, 'users', uid));
    if (snap.exists()) {
      window._state.userProfile = snap.data();
    }
  } catch (e) {}
}

window.saveProfile = async () => {
  const name = document.getElementById('profile-name').value.trim();
  const startDate = document.getElementById('profile-start-date').value;
  if (!startDate) return showNotif('×× × ×‘×—×¨ ×ª××¨×™×š ×ª×—×™×œ×ª ×¢×‘×•×“×”', 'error');
  try {
    await updateDoc(doc(db, 'users', window._state.user.uid), { name, startDate });
    window._state.userProfile.name = name;
    window._state.userProfile.startDate = startDate;
    updateHeaderUI();
    showNotif('×”×¤×¨×•×¤×™×œ × ×©××¨!', 'success');
    updateProfilePage();
  } catch (e) {
    showNotif('×©×’×™××” ×‘×©××™×¨×”', 'error');
  }
};

// ============================================================
// INIT
// ============================================================
async function initializeApp2() {
  updateHeaderUI();
  await loadShifts();
  populateMonthFilters();
  renderDashboard();
  renderShiftsPage();
  renderExportPage();
  updateProfilePage();
}

function updateHeaderUI() {
  const name = window._state.userProfile?.name || window._state.user?.email || '××©×ª××©';
  document.getElementById('header-name').textContent = name.split(' ')[0];
  document.getElementById('header-avatar').textContent = name.charAt(0).toUpperCase();
  document.getElementById('dash-name').textContent = name.split(' ')[0];
  const now = new Date();
  document.getElementById('dash-month').textContent = now.toLocaleDateString('he-IL', { year: 'numeric', month: 'long' });
}

// ============================================================
// SHIFTS CRUD
// ============================================================
async function loadShifts() {
  try {
    const q = query(
      collection(db, 'shifts'),
      where('uid', '==', window._state.user.uid),
      orderBy('date', 'desc')
    );
    const snap = await getDocs(q);
    window._state.shifts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch (e) {
    // Index may not be ready, try without orderBy
    try {
      const q2 = query(collection(db, 'shifts'), where('uid', '==', window._state.user.uid));
      const snap = await getDocs(q2);
      window._state.shifts = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => b.date.localeCompare(a.date));
    } catch (e2) {}
  }
}

// ============================================================
// MODAL STATE
// ============================================================
let _currentShiftType = '××œ××”';

window.selectType = (btn) => {
  document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  _currentShiftType = btn.dataset.type;
  document.getElementById('custom-name-group').style.display = _currentShiftType === '××—×¨' ? 'block' : 'none';
  const isOvernight = (_currentShiftType === '××œ××”' || _currentShiftType === '×œ×™×œ×”');
  document.getElementById('end-date-group').style.display = isOvernight ? 'block' : 'none';
  if (isOvernight) autoFillEndDate();
  updateSalaryPreview();
};

window.onDateChange = () => {
  const date = document.getElementById('shift-date').value;
  const startTime = document.getElementById('shift-start').value;
  autoDetectShabbat(date, startTime);
  autoFillEndDate();
  updateSalaryPreview();
};

window.onTimeChange = () => {
  const date = document.getElementById('shift-date').value;
  const startTime = document.getElementById('shift-start').value;
  autoDetectShabbat(date, startTime);
  autoFillEndDate();
  updateSalaryPreview();
};

function autoDetectShabbat(date, time) {
  const notice = document.getElementById('shabbat-notice');
  if (isShabbat(date, time) && _currentShiftType !== '×©×‘×ª' && _currentShiftType !== '×—×’') {
    notice.style.display = 'block';
    document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === '×©×‘×ª'));
    _currentShiftType = '×©×‘×ª';
    document.getElementById('custom-name-group').style.display = 'none';
    document.getElementById('end-date-group').style.display = 'none';
  } else if (!isShabbat(date, time) && _currentShiftType === '×©×‘×ª') {
    notice.style.display = 'none';
  }
}

function autoFillEndDate() {
  const date = document.getElementById('shift-date').value;
  const startTime = document.getElementById('shift-start').value;
  const endTime = document.getElementById('shift-end').value;
  const isOvernight = (_currentShiftType === '××œ××”' || _currentShiftType === '×œ×™×œ×”');
  if (isOvernight && date) {
    const endDateEl = document.getElementById('shift-end-date');
    if (!endDateEl.value) endDateEl.value = nextDay(date);
    // If end <= start, suggest next day
    if (startTime && endTime && parseTime(endTime) <= parseTime(startTime)) {
      if (!endDateEl.value || endDateEl.value === date) endDateEl.value = nextDay(date);
    }
  }
}

window.openAddShift = () => {
  document.getElementById('modal-shift-title').textContent = 'â• ×”×•×¡×¤×ª ××©××¨×ª';
  document.getElementById('edit-shift-id').value = '';
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('shift-date').value = today;
  document.getElementById('shift-end-date').value = nextDay(today);
  document.getElementById('shift-start').value = '16:00';
  document.getElementById('shift-end').value = '08:00';
  document.getElementById('shift-notes').value = '';
  document.getElementById('shift-custom-name').value = '';
  document.getElementById('shabbat-notice').style.display = 'none';
  document.getElementById('custom-name-group').style.display = 'none';
  _currentShiftType = '××œ××”';
  document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === '××œ××”'));
  document.getElementById('end-date-group').style.display = 'block';
  document.getElementById('save-shift-btn').textContent = '×©××•×¨ ××©××¨×ª';
  autoDetectShabbat(today, '16:00');
  updateSalaryPreview();
  document.getElementById('modal-add-shift').classList.add('open');
};

window.openEditShift = (id) => {
  const shift = window._state.shifts.find(s => s.id === id);
  if (!shift) return;
  document.getElementById('modal-shift-title').textContent = 'âœï¸ ×¢×¨×™×›×ª ××©××¨×ª';
  document.getElementById('edit-shift-id').value = id;
  document.getElementById('shift-date').value = shift.date;
  document.getElementById('shift-end-date').value = shift.endDate || nextDay(shift.date);
  document.getElementById('shift-start').value = shift.startTime;
  document.getElementById('shift-end').value = shift.endTime;
  document.getElementById('shift-notes').value = shift.notes || '';
  document.getElementById('shift-custom-name').value = shift.customName || '';
  document.getElementById('shabbat-notice').style.display = 'none';
  const type = shift.shiftType || '××œ××”';
  _currentShiftType = type;
  document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === type));
  document.getElementById('custom-name-group').style.display = type === '××—×¨' ? 'block' : 'none';
  const isOvernight = (type === '××œ××”' || type === '×œ×™×œ×”');
  document.getElementById('end-date-group').style.display = isOvernight ? 'block' : 'none';
  document.getElementById('save-shift-btn').textContent = '×¢×“×›×Ÿ ××©××¨×ª';
  updateSalaryPreview();
  document.getElementById('modal-add-shift').classList.add('open');
};

window.closeModal = () => {
  document.getElementById('modal-add-shift').classList.remove('open');
};

window.saveShift = async () => {
  const editId = document.getElementById('edit-shift-id').value;
  const date = document.getElementById('shift-date').value;
  const startTime = document.getElementById('shift-start').value;
  const endTime = document.getElementById('shift-end').value;
  const shiftType = _currentShiftType;
  const notes = document.getElementById('shift-notes').value.trim();
  const customName = document.getElementById('shift-custom-name').value.trim();

  const isOvernight = (shiftType === '××œ××”' || shiftType === '×œ×™×œ×”');
  let endDate = isOvernight
    ? (document.getElementById('shift-end-date').value || nextDay(date))
    : date;
  if (!isOvernight && parseTime(endTime) < parseTime(startTime)) endDate = nextDay(date);

  if (!date || !startTime || !endTime) return showNotif('×× × ××œ× ×ª××¨×™×š ×•×©×¢×•×ª', 'error');

  const workStartDate = window._state.userProfile?.startDate || null;
  const calc = calcShiftPay(date, startTime, endDate, endTime, shiftType, workStartDate);
  const totalHours = +(calc.totalMinutes / 60).toFixed(2);
  const displayName = shiftType === '××—×¨' && customName ? customName : shiftType.replace('_', ' ');

  const shiftData = {
    uid: window._state.user.uid,
    date, endDate, startTime, endTime,
    shiftType, customName: customName || '', displayName, notes,
    durationHours: totalHours,
    calculatedPay: calc.totalPay,
    payBreakdown: calc.breakdown,
    month: date.substring(0, 7)
  };

  const btn = document.getElementById('save-shift-btn');
  btn.innerHTML = '<div class="spinner"></div>';

  try {
    if (editId) {
      await updateDoc(doc(db, 'shifts', editId), shiftData);
      const idx = window._state.shifts.findIndex(s => s.id === editId);
      if (idx >= 0) window._state.shifts[idx] = { id: editId, ...shiftData };
      showNotif('×”××©××¨×ª ×¢×•×“×›× ×”!', 'success');
    } else {
      const ref = await addDoc(collection(db, 'shifts'), shiftData);
      window._state.shifts.unshift({ id: ref.id, ...shiftData });
      showNotif('×”××©××¨×ª × ×•×¡×¤×”!', 'success');
    }
    closeModal();
    renderDashboard();
    renderShiftsPage();
  } catch (e) {
    showNotif('×©×’×™××” ×‘×©××™×¨×”: ' + e.message, 'error');
  }
  btn.textContent = editId ? '×¢×“×›×Ÿ ××©××¨×ª' : '×©××•×¨ ××©××¨×ª';
};

window.deleteShift = async (id) => {
  if (!confirm('×œ××—×•×§ ××©××¨×ª ×–×•?')) return;
  try {
    await deleteDoc(doc(db, 'shifts', id));
    window._state.shifts = window._state.shifts.filter(s => s.id !== id);
    renderDashboard();
    renderShiftsPage();
    showNotif('×”××©××¨×ª × ××—×§×”', 'success');
  } catch (e) {
    showNotif('×©×’×™××” ×‘××—×™×§×”', 'error');
  }
};

// ============================================================
// SALARY PREVIEW in modal
// ============================================================
window.updateSalaryPreview = () => {
  const date = document.getElementById('shift-date').value;
  const start = document.getElementById('shift-start').value;
  const end = document.getElementById('shift-end').value;
  const type = _currentShiftType;
  const isOvernight = (type === '××œ××”' || type === '×œ×™×œ×”');
  let endDate = isOvernight
    ? (document.getElementById('shift-end-date').value || nextDay(date))
    : date;
  if (!isOvernight && parseTime(end) < parseTime(start)) endDate = nextDay(date);

  const workStartDate = window._state.userProfile?.startDate || null;
  const calc = calcShiftPay(date, start, endDate, end, type, workStartDate);

  // Duration hint
  const hint = document.getElementById('duration-hint');
  if (calc.totalMinutes > 0) {
    const totalH = calc.totalMinutes / 60;
    const h = Math.floor(totalH);
    const m = Math.round((totalH - h) * 60);
    const endNote = endDate && endDate !== date ? ` Â· ×™×¦×™××” ${endDate}` : '';
    hint.textContent = `â± ×¡×”"×› ${h} ×©×¢×•×ª${m > 0 ? ' ×•-' + m + ' ×“×§×•×ª' : ''}${endNote}`;
    hint.style.display = 'block';
  } else {
    hint.style.display = 'none';
  }

  const rate = getHourlyRate(workStartDate);
  let html = '';
  if (calc.breakdown.length === 0) {
    html = '<div style="color:var(--text-muted); font-size:13px;">××œ× ×ª××¨×™×š ×•×©×¢×•×ª ×œ×—×™×©×•×‘</div>';
  } else {
    calc.breakdown.forEach(b => {
      html += '<div class="salary-row"><span>' + b.label + '</span><span style="font-weight:600">â‚ª' + b.pay.toFixed(0) + '</span></div>';
    });
    html += '<div class="salary-row" style="border-top:1.5px solid rgba(124,92,252,0.2);margin-top:4px;padding-top:8px;">' +
      '<span style="font-weight:700;font-size:15px;">×¡×”"×›</span>' +
      '<span class="salary-total" style="font-size:20px;">â‚ª' + calc.totalPay.toFixed(0) + '</span></div>';
    html += '<div style="font-size:11px;color:var(--text-muted);margin-top:6px;">×ª×¢×¨×™×£: â‚ª' + rate + '/×©×¢×”</div>';
  }
  document.getElementById('salary-preview-content').innerHTML = html;
};

// ============================================================
// RENDER DASHBOARD
// ============================================================
function renderDashboard() {
  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const monthShifts = window._state.shifts.filter(s => s.month === currentMonth);

  const totalHours = monthShifts.reduce((sum, s) => sum + (s.durationHours || 0), 0);
  const totalPay = monthShifts.reduce((sum, s) => sum + (s.calculatedPay || 0), 0);
  const nightShifts = monthShifts.filter(s => s.shiftType === '×œ×™×œ×”' || s.shiftType === '××œ××”').length;

  document.getElementById('stat-hours').textContent = totalHours.toFixed(1);
  document.getElementById('stat-gross').textContent = 'â‚ª' + Math.round(totalPay).toLocaleString();
  document.getElementById('stat-shifts').textContent = monthShifts.length;
  document.getElementById('stat-night').textContent = nightShifts;

  // Recent shifts (last 5)
  const recent = window._state.shifts.slice(0, 5);
  const container = document.getElementById('recent-shifts-list');
  if (recent.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸŒ™</div><div class="empty-text">×¢×“×™×™×Ÿ ××™×Ÿ ××©××¨×•×ª</div><div class="empty-sub">×”×•×¡×£/×™ ××ª ×”××©××¨×ª ×”×¨××©×•× ×” ×©×œ×š</div></div>`;
  } else {
    container.innerHTML = recent.map(s => renderShiftItem(s)).join('');
  }
}

// ============================================================
// RENDER SHIFTS PAGE
// ============================================================
function populateMonthFilters() {
  const months = [...new Set(window._state.shifts.map(s => s.month))].sort().reverse();
  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  if (!months.includes(currentMonth)) months.unshift(currentMonth);

  const heMonths = { '01':'×™× ×•××¨','02':'×¤×‘×¨×•××¨','03':'××¨×¥','04':'××¤×¨×™×œ','05':'×××™','06':'×™×•× ×™','07':'×™×•×œ×™','08':'××•×’×•×¡×˜','09':'×¡×¤×˜××‘×¨','10':'××•×§×˜×•×‘×¨','11':'× ×•×‘××‘×¨','12':'×“×¦××‘×¨' };

  ['filter-month', 'export-month'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = months.map(m => {
      const [y, mo] = m.split('-');
      return `<option value="${m}">${heMonths[mo]} ${y}</option>`;
    }).join('');
  });
}

window.renderShiftsPage = () => {
  const month = document.getElementById('filter-month')?.value || '';
  const filtered = month ? window._state.shifts.filter(s => s.month === month) : window._state.shifts;
  const container = document.getElementById('all-shifts-list');
  if (filtered.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">××™×Ÿ ××©××¨×•×ª ×‘×—×•×“×© ×–×”</div></div>`;
  } else {
    container.innerHTML = filtered.map(s => renderShiftItem(s, true)).join('');
  }
};

function renderShiftItem(s, showActions = false) {
  const d = new Date(s.date);
  const day = d.getDate();
  const month = d.toLocaleDateString('he-IL', { month: 'short' });
  const typeKey = s.shiftType || '';
  const badgeClass = {
    '×œ×™×œ×”': 'badge-night', '×™×•××™×ª': 'badge-day', '×©×‘×ª': 'badge-shabbat',
    '×—×’': 'badge-holiday', '×”×›×©×¨×”': 'badge-training', '×™×©×™×‘×ª_×¦×•×•×ª': 'badge-meeting',
    '××œ××”': 'badge-full', '××—×¨': 'badge-day'
  }[typeKey] || 'badge-day';

  const displayName = s.displayName || s.shiftType?.replace('_', ' ') || 'â€”';
  const isOvernight = s.endDate && s.endDate !== s.date;
  const timeStr = isOvernight
    ? `${s.startTime} (${s.date}) â†’ ${s.endTime} (${s.endDate})`
    : `${s.startTime} â€“ ${s.endTime}`;

  return `<div class="glass shift-item">
    <div class="shift-date-badge">
      <div class="shift-day">${day}</div>
      <div class="shift-month">${month}</div>
    </div>
    <div class="shift-info">
      <div><span class="shift-type-badge ${badgeClass}">${displayName}</span></div>
      <div class="shift-times">${timeStr} Â· ${s.durationHours}×©${s.notes ? ' Â· ' + s.notes : ''}</div>
    </div>
    <div style="text-align:left;">
      <div class="shift-pay">â‚ª${Math.round(s.calculatedPay || 0).toLocaleString()}</div>
      <div class="shift-hours">${s.durationHours}×©</div>
    </div>
    <div class="shift-actions">
      <button class="btn btn-glass btn-sm" onclick="openEditShift('${s.id}')">âœï¸</button>
      <button class="btn btn-danger btn-sm" onclick="deleteShift('${s.id}')">ğŸ—‘ï¸</button>
    </div>
  </div>`;
}

// ============================================================
// EXPORT
// ============================================================
window.renderExportPage = () => {
  const month = document.getElementById('export-month')?.value;
  if (!month) return;
  const shifts = window._state.shifts.filter(s => s.month === month);
  if (shifts.length === 0) {
    document.getElementById('export-preview-content').innerHTML = '<span style="color:var(--text-muted)">××™×Ÿ ××©××¨×•×ª ×‘×—×•×“×© ×–×”</span>';
    return;
  }
  const name = window._state.userProfile?.name || '';
  const totalHours = shifts.reduce((sum, s) => sum + (s.durationHours || 0), 0);
  const totalPay = shifts.reduce((sum, s) => sum + (s.calculatedPay || 0), 0);

  document.getElementById('export-preview-content').innerHTML = `
    <div style="margin-bottom:8px;"><strong>${name}</strong> â€” ${month}</div>
    <div style="color:var(--text-muted)">×¡×”"×› ××©××¨×•×ª: ${shifts.length} | ×¡×”"×› ×©×¢×•×ª: ${totalHours.toFixed(2)} | ×¡×”"×› ×©×›×¨: â‚ª${Math.round(totalPay).toLocaleString()}</div>
  `;
};

document.getElementById('export-month')?.addEventListener('change', renderExportPage);

window.exportCSV = () => {
  const month = document.getElementById('export-month').value;
  const shifts = window._state.shifts.filter(s => s.month === month);
  const name = window._state.userProfile?.name || '×¢×•×‘×“';

  let csv = '\uFEFF'; // BOM for Hebrew
  csv += `×¡×™×›×•× ×©×¢×•×ª\r\n${name}\r\n`;
  csv += '×ª××¨×™×š,×›× ×™×¡×” ×‘××¢×¨×›×ª,×ª×™×§×•×Ÿ ×›× ×™×¡×”,×™×¦×™××” ×‘××¢×¨×›×ª,×ª×™×§×•×Ÿ ×™×¦×™××”,×¡×•×’ ××©××¨×ª,×”×¢×¨×•×ª,×¡×™×›×•× ×–××Ÿ,×©×›×¨\r\n';

  shifts.sort((a, b) => a.date.localeCompare(b.date)).forEach(s => {
    csv += `${s.date},${s.startTime},,${s.endTime},,${s.shiftType.replace('_',' ')},${s.notes || ''},${s.durationHours},${s.calculatedPay}\r\n`;
  });

  const totalH = shifts.reduce((sum, s) => sum + (s.durationHours || 0), 0);
  const totalP = shifts.reduce((sum, s) => sum + (s.calculatedPay || 0), 0);
  csv += `,,,,,,×¡×”"×›,${totalH.toFixed(2)},${totalP.toFixed(2)}\r\n`;

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `×“×•×—_×©×¢×•×ª_${name}_${month}.csv`;
  a.click();
  showNotif('×”×“×•×— ×™×•×¦× ×‘×”×¦×œ×—×”!', 'success');
};

window.exportExcelLike = () => exportCSV(); // Same CSV works in Excel with .csv extension

// ============================================================
// PROFILE PAGE
// ============================================================
window.updateProfilePage = () => {
  const p = window._state.userProfile;
  document.getElementById('profile-name').value = p?.name || '';
  document.getElementById('profile-start-date').value = p?.startDate || '';
  const months = calcSeniorityMonths(p?.startDate);
  const rate = getHourlyRate(p?.startDate);
  document.getElementById('profile-rate').textContent = `â‚ª${rate} ×œ×©×¢×”`;
  const display = document.getElementById('profile-seniority-display');
  if (p?.startDate) {
    const years = Math.floor(months / 12);
    const remMonths = months % 12;
    let text = `×•×ª×§: `;
    if (years > 0) text += `${years} ×©× ×”${years > 1 ? '×™×' : ''} `;
    if (remMonths > 0) text += `×•-${remMonths} ×—×•×“×©×™×`;
    if (years === 0 && remMonths === 0) text += '×¤×—×•×ª ××—×•×“×©';
    display.textContent = text;
  } else {
    display.textContent = '';
  }
};

// ============================================================
// ADMIN
// ============================================================
// Admin password is stored as a hash concept â€” not plaintext in DOM
// The password "1414" is checked via a simple obfuscated comparison
window.checkAdminPass = () => {
  const pass = document.getElementById('admin-password').value;
  // Simple hash-like check: sum of char codes === expected value
  const expected = 49 + 52 + 49 + 52; // "1414" char codes
  const actual = pass.split('').reduce((s, c) => s + c.charCodeAt(0), 0);
  if (pass.length === 4 && actual === expected) {
    window._state.adminAuthed = true;
    document.getElementById('admin-gate').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
    loadAdminUsers();
  } else {
    showNotif('×¡×™×¡××” ×©×’×•×™×”', 'error');
    document.getElementById('admin-password').value = '';
  }
};

window.loadAdminUsers = async () => {
  const container = document.getElementById('admin-users-list');
  container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">×˜×•×¢×Ÿ...</div>';
  try {
    const snap = await getDocs(collection(db, 'users'));
    const users = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    if (users.length === 0) {
      container.innerHTML = '<div style="color:var(--text-muted); padding:12px;">××™×Ÿ ××©×ª××©×™×</div>';
      return;
    }

    container.innerHTML = users.map(u => `
      <div class="user-row">
        <div class="user-avatar" style="min-width:36px;">${(u.name || u.username || '?').charAt(0).toUpperCase()}</div>
        <div class="user-info">
          <div class="user-email">${u.name || 'â€”'}</div>
          <div class="user-meta">@${u.username || 'â€”'} Â· ×”×ª×—×™×œ: ${u.startDate || '×œ× ×™×“×•×¢'}</div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="adminDeleteUser('${u.id}')">ğŸ—‘ï¸ ××—×§</button>
      </div>
    `).join('');

    document.getElementById('admin-stats').innerHTML = `
      <div>×¡×”"×› ××©×ª××©×™×: <strong>${users.length}</strong></div>
    `;
  } catch (e) {
    container.innerHTML = `<div style="color:var(--danger)">×©×’×™××”: ${e.message}</div>`;
  }
};

window.adminDeleteUser = async (uid) => {
  if (!confirm('×œ××—×•×§ ××©×ª××© ×–×” ×œ×¦××™×ª×•×ª?\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ×’× ××ª ×›×œ ×”××©××¨×•×ª ×©×œ×•!')) return;
  try {
    // Delete user shifts
    const q = query(collection(db, 'shifts'), where('uid', '==', uid));
    const snap = await getDocs(q);
    for (const d of snap.docs) await deleteDoc(d.ref);
    // Delete user profile
    await deleteDoc(doc(db, 'users', uid));
    showNotif('×”××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”', 'success');
    loadAdminUsers();
  } catch (e) {
    showNotif('×©×’×™××” ×‘××—×™×§×”: ' + e.message, 'error');
  }
};

// ============================================================
// NAVIGATION
// ============================================================
window.showPage = (page) => {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page)?.classList.add('active');
  document.getElementById('nav-' + page)?.classList.add('active');

  if (page === 'shifts') renderShiftsPage();
  if (page === 'export') { populateMonthFilters(); renderExportPage(); }
  if (page === 'profile') updateProfilePage();
};

// ============================================================
// NOTIFICATIONS
// ============================================================
window.showNotif = (msg, type = 'success') => {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.className = 'notif show ' + type;
  setTimeout(() => el.classList.remove('show'), 3000);
};

// Real-time preview as user changes shift times/type
document.addEventListener('DOMContentLoaded', () => {
  ['shift-start', 'shift-end'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', updateSalaryPreview);
  });
});

</script>
</body>
</html>
